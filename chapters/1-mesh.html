

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Example: mesh a delineated watershed &#8212; ATS Watershed Workflow</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/1-mesh';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Download Daymet" href="2-daymet.html" />
    <link rel="prev" title="ATS modeling workflow" href="../intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    <p class="title logo__title">ATS Watershed Workflow</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    ATS modeling workflow
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Setup</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Generate Watershed Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="2-daymet.html">Download Daymet</a></li>

<li class="toctree-l1"><a class="reference internal" href="3-ats_input_file.html">Generate ATS Input File</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Run</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="run.html">Run ATS on Local/HPC Machine</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Post-processes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="plot_surface.html">Plot surface variables</a></li>




<li class="toctree-l1"><a class="reference internal" href="plot_subsurface.html">Plot subsurface variables</a></li>




<li class="toctree-l1"><a class="reference internal" href="model_evaluation.html">Model Evaluation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Sensitivity Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="sensitivity_analysis.html">Sensitivity analysis</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Calibration</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="model_calibration.html">Model calibration using Machine Learning</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/pinshuai/ats-workflow" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pinshuai/ats-workflow/issues/new?title=Issue%20on%20page%20%2Fchapters/1-mesh.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/chapters/1-mesh.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example: mesh a delineated watershed</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sources-and-setup">Sources and setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sources">Sources</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-the-surface-mesh">Generate the surface mesh</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#meshing">Meshing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-watershed-outlet-optional">Add watershed outlet (optional)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surface-properties">Surface properties</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#land-cover">Land Cover</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lai">LAI</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#subsurface-properties">Subsurface properties</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ssurgo-soil-properties">SSURGO Soil Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#glhymps-geologic-layer">GLHYMPS geologic layer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#depth-to-bedrock">Depth-to-bedrock</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mesh-extrusion">Mesh extrusion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-mesh-file">Save mesh file</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="example-mesh-a-delineated-watershed">
<h1>Example: mesh a delineated watershed<a class="headerlink" href="#example-mesh-a-delineated-watershed" title="Permalink to this heading">#</a></h1>
<p>Here we mesh the Coal Creek Watershed, CO as an example of how to pull data in from default locations and generate a fully functional ATS mesh.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> <span class="k">as</span> <span class="n">pcm</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
<span class="c1"># from matplotlib_scalebar.scalebar import ScaleBar</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="kc">None</span>


<span class="kn">import</span> <span class="nn">watershed_workflow</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.source_list</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.ui</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.colors</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.condition</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.mesh</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.split_hucs</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.land_cover_properties</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">figsize_3d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">modvis</span> <span class="kn">import</span> <span class="n">ATSutils</span>
</pre></div>
</div>
</div>
</div>
<section id="sources-and-setup">
<h2>Sources and setup<a class="headerlink" href="#sources-and-setup" title="Permalink to this heading">#</a></h2>
<p>Next we set up the source watershed and coordinate system and all data sources for our mesh.  We will use the CRS (in UTM coordinates) that is included in the shapefile.</p>
<p><span style="color:blue;">If the CRS is in lat-lon (in degrees), convert it to UTM (in meters).</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># specify the input shapefile and a hint as to what HUC it is in.</span>
<span class="n">watershed_shapefile</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/sources/shapefile/CoalCreek.shp&#39;</span>
<span class="n">watershed_landcover</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/sources/land_cover/NLCD/CoalCreek_nlcd2016.tif&#39;</span>
<span class="n">watershed_glhymps</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/sources/GLHYMPS/CoalCreek_glhymps_v2.shp&#39;</span>
<span class="n">watershed_dtb</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/sources/DTB/CoalCreek_dtb.tif&#39;</span>
<span class="n">watershed_modis_lulc</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/sources/land_cover/MODIS/MCD12Q1.006_500m_aid0001.nc&#39;</span>
<span class="n">watershed_modis_lai</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/sources/land_cover/MODIS/MCD15A3H.006_500m_aid0001.nc&#39;</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># this will store all the filenames used in input file</span>
<span class="n">config_fname</span> <span class="o">=</span> <span class="s1">&#39;../../data/examples/CoalCreek/processed/config.yaml&#39;</span>

<span class="n">hint</span> <span class="o">=</span> <span class="s1">&#39;1402&#39;</span>  <span class="c1"># hint: HUC 4 containing this shape.  </span>
               <span class="c1"># This is necessary to avoid downloading all HUCs to search for this shape</span>
<span class="n">huc</span> <span class="o">=</span> <span class="s2">&quot;140200010204&quot;</span> <span class="c1"># provide the huc code for that watershed. If None, the script will automatically search for the HUC code.</span>
<span class="n">simplify</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># length scale to target average edge, same unit as the watershed CRS</span>

<span class="c1"># start and end of simulation -- one year of simulation that is in both the MODIS and DayMet dataset ranges</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s2">&quot;2015-10-1&quot;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s2">&quot;2016-10-1&quot;</span>
<span class="c1"># origin of simulation. By default, use the first available date of Daymet forcing. </span>
<span class="c1"># This is necessary to ensure that all datesets use the same origin date.</span>
<span class="n">origin_date</span> <span class="o">=</span> <span class="s2">&quot;1980-1-1&quot;</span>

<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Meshing shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">watershed_shapefile</span><span class="p">))</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># get the shape and crs of the shape</span>
<span class="n">crs</span><span class="p">,</span> <span class="n">watershed</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_split_form_shapes</span><span class="p">(</span><span class="n">watershed_shapefile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:11:21,257 - root - INFO: 
2023-07-19 19:11:21,261 - root - INFO: Meshing shape: ../../data/examples/CoalCreek/sources/shapefile/CoalCreek.shp
2023-07-19 19:11:21,265 - root - INFO: ==============================
2023-07-19 19:11:21,272 - root - INFO: 
2023-07-19 19:11:21,276 - root - INFO: Loading shapes
2023-07-19 19:11:21,279 - root - INFO: ------------------------------
2023-07-19 19:11:21,282 - root - INFO: Loading file: &#39;../../data/examples/CoalCreek/sources/shapefile/CoalCreek.shp&#39;
2023-07-19 19:11:21,461 - root - INFO: ... found 1 shapes
2023-07-19 19:11:21,466 - root - INFO: Converting to shapely
</pre></div>
</div>
</div>
</div>
<section id="sources">
<h3>Sources<a class="headerlink" href="#sources" title="Permalink to this heading">#</a></h3>
<p>A wide range of data sources are available and shown below:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head text-center"><p>source</p></th>
<th class="head text-center"><p>File_Manager</p></th>
<th class="head text-center"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>sources[‘DEM’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerNED()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">arc-second</span></code> (*); <code class="docutils literal notranslate"><span class="pre">1/3</span> <span class="pre">arc-second</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>sources[‘HUC’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerNHD()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">NHDPlus</span></code> (*); <code class="docutils literal notranslate"><span class="pre">NHD</span></code>; <code class="docutils literal notranslate"><span class="pre">WBD</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>sources[‘hydrography’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerNHD()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">NHDPlus</span></code> (*); <code class="docutils literal notranslate"><span class="pre">NHD</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>sources[‘land cover’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerNLCD()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">NLCD</span> <span class="pre">(L48)</span></code> (*); <code class="docutils literal notranslate"><span class="pre">NLCD</span> <span class="pre">(AK)</span></code>; <code class="docutils literal notranslate"><span class="pre">MODIS</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>sources[‘geologic structure’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerGLHYMPS()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">GLHYMPS</span></code> (*)</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>sources[‘soil structure’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerNRCS()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">NRCS</span> <span class="pre">SSURGO</span></code> (*)</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>sources[‘DTB’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerSoilGrids2017()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">SoilGrids2017</span></code> (*)</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>sources[‘lai’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerMODISAppEEARS()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">MODIS</span></code> (*)</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>sources[‘meteorology’]</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">FileManagerDaymet()</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">DayMet</span></code> (*)</p></td>
</tr>
</tbody>
</table>
<p>Note, custom sources can be imported using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># if raster</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;SOURCE NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerRaster</span><span class="p">(</span><span class="s1">&#39;PATH/TO/RASTER&#39;</span><span class="p">)</span>

<span class="c1"># for example</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;depth to bedrock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerRaster</span><span class="p">(</span><span class="s1">&#39;./Global_absoluteDTB_M_250m_ll.tif&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, Watershed-Workflow (WW) will place all the downloads in a folder named <code class="docutils literal notranslate"><span class="pre">data_library</span></code> or the mounted data volume and has the following structure (generated by WW):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
├──<span class="w"> </span>dem
│<span class="w">   </span>├──<span class="w"> </span>13as_raw
│<span class="w">   </span>└──<span class="w"> </span>1as_raw
├──<span class="w"> </span>hydrography
├──<span class="w"> </span>land_cover
│<span class="w">   </span>├──<span class="w"> </span>MODIS
│<span class="w">   </span>├──<span class="w"> </span>NLCD_2016_Land_Cover_L48
│<span class="w">   </span>└──<span class="w"> </span>NLCD_2019_Land_Cover_L48
├──<span class="w"> </span>meteorology
│<span class="w">   </span>└──<span class="w"> </span>daymet
└──<span class="w"> </span>soil_structure
<span class="w">    </span>├──<span class="w"> </span>GLHYMPS
<span class="w">    </span>├──<span class="w"> </span>SSURGO
<span class="w">    </span>├──<span class="w"> </span>SoilGrids2017
<span class="w">    </span>└──<span class="w"> </span>depth-to-bedrock
</pre></div>
</div>
<p>Some of the sources do not have API and they need to be downloaded manually. Here are a list of sources to download:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head text-center"><p>source</p></th>
<th class="head text-center"><p>Download Link</p></th>
<th class="head text-center"><p>Local Path</p></th>
<th class="head text-center"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>GLHYMPS v2</p></td>
<td class="text-center"><p><a class="reference external" href="https://doi.org/10.5683/SP2/TTJNIU">link</a></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">data/soil_structure/GLHYMPS</span></code></p></td>
<td class="text-center"><p>~2.4 GB. Unzip the .zip file and place all the files under the path</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Depth-to-bedrock (~2.4 GB)</p></td>
<td class="text-center"><p><a class="reference external" href="http://globalchange.bnu.edu.cn/research/dtb.jsp">Link</a></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">data/soil_structure/depth-to-bedrock</span></code></p></td>
<td class="text-center"><p>~10 GB. Look for file named <code class="docutils literal notranslate"><span class="pre">Global_absoluteDTB_M_250m_ll.tif</span></code> (250 m resolution). This file is slightly different from the data found in <a class="reference external" href="https://soilgrids.org/">SoilGrids</a>. Why?</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up a dictionary of source objects</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">get_default_sources</span><span class="p">()</span>
<span class="c1"># sources[&#39;depth to bedrock&#39;] = watershed_workflow.source_list.FileManagerSoilGrids2017()</span>

<span class="c1">#</span>
<span class="c1"># This demo uses a few datasets that have been clipped out of larger, national</span>
<span class="c1"># datasets and are distributed with the code.  This is simply to save download</span>
<span class="c1"># time for this simple problem and to lower the barrier for trying out</span>
<span class="c1"># Watershed Workflow.  A more typical workflow would delete these lines (as </span>
<span class="c1"># these files would not exist for other watersheds).</span>
<span class="c1">#</span>
<span class="c1"># The default versions of these download large raster and shapefile files that</span>
<span class="c1"># are defined over a very large region (globally or the entire US).</span>
<span class="c1">#</span>
<span class="c1"># Note we also prepopulate some data for MODIS data as well.</span>
<span class="c1">#</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;land cover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerRaster</span><span class="p">(</span><span class="n">watershed_landcover</span><span class="p">)</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;geologic structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerGLHYMPS</span><span class="p">(</span><span class="n">watershed_glhymps</span><span class="p">)</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;depth to bedrock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerRaster</span><span class="p">(</span><span class="n">watershed_dtb</span><span class="p">)</span>
<span class="c1"># sources[&#39;MODIS LULC&#39;] = watershed_workflow.source_list.FileManagerRaster(watershed_modis_lulc)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">log_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:11:21,613 - root - INFO: Using sources:
2023-07-19 19:11:21,616 - root - INFO: --------------
2023-07-19 19:11:21,621 - root - INFO: HUC: National Hydrography Dataset Plus High Resolution (NHDPlus HR)
2023-07-19 19:11:21,625 - root - INFO: hydrography: National Hydrography Dataset Plus High Resolution (NHDPlus HR)
2023-07-19 19:11:21,630 - root - INFO: DEM: National Elevation Dataset (NED)
2023-07-19 19:11:21,635 - root - INFO: soil structure: National Resources Conservation Service Soil Survey (NRCS Soils)
2023-07-19 19:11:21,638 - root - INFO: geologic structure: ../../data/examples/CoalCreek/sources/GLHYMPS/CoalCreek_glhymps_v2.shp
2023-07-19 19:11:21,642 - root - INFO: land cover: raster
2023-07-19 19:11:21,645 - root - INFO: lai: MODIS
2023-07-19 19:11:21,649 - root - INFO: soil thickness: None
2023-07-19 19:11:21,653 - root - INFO: meteorology: DayMet 1km
2023-07-19 19:11:21,657 - root - INFO: depth to bedrock: raster
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># immediately put in request for land cover data -- downloading from Appeears</span>
<span class="c1"># can take some time as they must synthesize the data </span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="generate-the-surface-mesh">
<h2>Generate the surface mesh<a class="headerlink" href="#generate-the-surface-mesh" title="Permalink to this heading">#</a></h2>
<p>First we’ll generate the flattened, 2D triangulation, which builds on hydrography data.  Then we download a digital elevation map from the National Elevation Dataset, and extrude that 2D triangulation to a 3D surface mesh based on interpolation between pixels of the DEM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find what HUC our shape is in</span>
<span class="k">if</span> <span class="n">huc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">huc</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">find_huc</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;HUC&#39;</span><span class="p">],</span> <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">shrink_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found watershed in HUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">huc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:11:21,890 - root - INFO: Found watershed in HUC: 140200010204
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rivers</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">rivers</span><span class="p">:</span>
    <span class="c1"># download/collect the river network within that shape&#39;s bounds</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">reaches</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_reaches</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;hydrography&#39;</span><span class="p">],</span> <span class="n">huc</span><span class="p">,</span> 
                                      <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># simplify and prune rivers not IN the shape, constructing a tree-like data structure</span>
    <span class="c1"># for the river network</span>
    <span class="n">rivers</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">construct_rivers</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">reaches</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hydroseq&#39;</span><span class="p">,</span> 
                                                <span class="n">prune_by_area_fraction</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">rivers</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">simplify_hucs</span><span class="o">=</span><span class="n">simplify</span><span class="p">,</span> <span class="n">simplify_rivers</span><span class="o">=</span><span class="n">simplify</span><span class="p">,</span>
                               <span class="n">snap_rivers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cut_intersections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">rivers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">split_hucs</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">simplify</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:11:22,041 - root - INFO: 
2023-07-19 19:11:22,044 - root - INFO: Loading Hydrography
2023-07-19 19:11:22,048 - root - INFO: ------------------------------
2023-07-19 19:11:22,051 - root - INFO: Loading streams in HUC 140200010204
2023-07-19 19:11:22,060 - root - INFO:          and/or bounds (317251.2640131897, 4299711.408984916, 328473.7039815487, 4307062.45088187)
2023-07-19 19:11:22,068 - root - INFO:   Using Hydrography file &quot;/home/jovyan/data/hydrography/NHDPlus_H_1402_GDB/NHDPlus_H_1402.gdb&quot;
2023-07-19 19:11:22,072 - root - INFO:   National Hydrography Dataset Plus High Resolution (NHDPlus HR): opening &#39;/home/jovyan/data/hydrography/NHDPlus_H_1402_GDB/NHDPlus_H_1402.gdb&#39; layer &#39;NHDFlowline&#39; for streams in &#39;(317251.2640131897, 4299711.408984916, 328473.7039815487, 4307062.45088187)&#39;
2023-07-19 19:11:22,962 - root - INFO:   Found total of 205 in bounds.
2023-07-19 19:11:22,969 - root - INFO:   Filtering reaches not in-network
2023-07-19 19:11:22,974 - root - INFO:   National Hydrography Dataset Plus High Resolution (NHDPlus HR): opening &#39;/home/jovyan/data/hydrography/NHDPlus_H_1402_GDB/NHDPlus_H_1402.gdb&#39; layer &#39;NHDPlusFlowlineVAA&#39; for river network properties in &#39;(-107.10720481215337, 38.82724324194855, -106.97604331554375, 38.89570604410164)&#39;
2023-07-19 19:11:34,854 - root - INFO:   National Hydrography Dataset Plus High Resolution (NHDPlus HR): opening &#39;/home/jovyan/data/hydrography/NHDPlus_H_1402_GDB/NHDPlus_H_1402.gdb&#39; layer &#39;NHDPlusEROMMA&#39; for river network properties in &#39;(-107.10720481215337, 38.82724324194855, -106.97604331554375, 38.89570604410164)&#39;
2023-07-19 19:11:43,355 - root - INFO: ... found 201 reaches
2023-07-19 19:11:43,359 - root - INFO: Converting to shapely
2023-07-19 19:11:43,496 - root - INFO: Converting to out_crs
2023-07-19 19:11:43,775 - root - INFO: Removed 83 of 201 reaches not in shape
2023-07-19 19:11:43,780 - root - INFO: 
2023-07-19 19:11:43,783 - root - INFO: Constructing river network
2023-07-19 19:11:43,785 - root - INFO: ------------------------------
2023-07-19 19:11:43,788 - root - INFO: Generating the river tree
2023-07-19 19:11:43,793 - root - INFO:  ... generated 2 rivers
2023-07-19 19:11:43,801 - root - INFO: Pruning by fractional contributing area &lt; 0.01
2023-07-19 19:11:43,806 - root - INFO: ... total contributing area = 193.58910018
2023-07-19 19:11:43,809 - root - INFO: ... removing: 0.48949999 of 193.58910018
2023-07-19 19:11:43,814 - root - INFO: ... removing: 0.36239995 of 193.58910018
2023-07-19 19:11:43,819 - root - INFO: ... removing: 1.92720001 of 193.58910018
2023-07-19 19:11:43,823 - root - INFO: ... removing: 0.8301999800000001 of 193.58910018
2023-07-19 19:11:43,828 - root - INFO: ... removing: 0.18070001 of 193.58910018
2023-07-19 19:11:43,836 - root - INFO: ... removing: 0.38759999 of 193.58910018
2023-07-19 19:11:43,841 - root - INFO: ... removing: 0.83940003 of 193.58910018
2023-07-19 19:11:43,846 - root - INFO: ... removing: 0.5789000000000001 of 193.58910018
2023-07-19 19:11:43,852 - root - INFO: ... removing: 0.95399999 of 193.58910018
2023-07-19 19:11:43,855 - root - INFO: ... removing: 0.97809997 of 193.58910018
2023-07-19 19:11:43,859 - root - INFO: ... removing: 0.7281000200000001 of 193.58910018
2023-07-19 19:11:43,865 - root - INFO: ... removing: 0.53450003 of 193.58910018
2023-07-19 19:11:43,868 - root - INFO: ... removing: 0.33420002 of 193.58910018
2023-07-19 19:11:43,873 - root - INFO: ... removing: 1.7706000000000002 of 193.58910018
2023-07-19 19:11:43,876 - root - INFO: ... removing: 0.40239999 of 193.58910018
2023-07-19 19:11:43,883 - root - INFO: ... removing: 0.3447 of 193.58910018
2023-07-19 19:11:43,887 - root - INFO: ... removing: 1.79579997 of 193.58910018
2023-07-19 19:11:43,890 - root - INFO: ... removing: 0.9384999700000001 of 193.58910018
2023-07-19 19:11:43,895 - root - INFO: ... removing: 1.10790005 of 193.58910018
2023-07-19 19:11:43,898 - root - INFO: ... removing: 1.42430003 of 193.58910018
2023-07-19 19:11:43,902 - root - INFO: ... removing: 1.48390002 of 193.58910018
2023-07-19 19:11:43,905 - root - INFO: ... removing: 0.87100001 of 193.58910018
2023-07-19 19:11:43,911 - root - INFO: ... removing: 0.19800001 of 193.58910018
2023-07-19 19:11:43,914 - root - INFO: ... removing: 0.4647 of 193.58910018
2023-07-19 19:11:43,920 - root - INFO: ... removing: 0.50140003 of 193.58910018
2023-07-19 19:11:43,924 - root - INFO: ... removing: 0.7591999700000001 of 193.58910018
2023-07-19 19:11:43,929 - root - INFO: ... removing: 0.5633 of 193.58910018
2023-07-19 19:11:43,935 - root - INFO: ... removing: 0.63440005 of 193.58910018
2023-07-19 19:11:43,938 - root - INFO: ... removing: 0.62940001 of 193.58910018
2023-07-19 19:11:43,942 - root - INFO: ... removing: 1.87300002 of 193.58910018
2023-07-19 19:11:43,946 - root - INFO: ... removing: 1.8664 of 193.58910018
2023-07-19 19:11:43,950 - root - INFO: ... removing: 0.33550002 of 193.58910018
2023-07-19 19:11:43,954 - root - INFO: ... removing: 1.05729998 of 193.58910018
2023-07-19 19:11:43,958 - root - INFO: ... total contributing area = 193.58910018
2023-07-19 19:11:43,962 - root - INFO: ... pruned 33
2023-07-19 19:11:43,965 - root - INFO: 
2023-07-19 19:11:43,968 - root - INFO: Simplifying
2023-07-19 19:11:43,971 - root - INFO: ------------------------------
2023-07-19 19:11:43,975 - root - INFO: Simplifying rivers
2023-07-19 19:11:44,033 - root - INFO:   ...cleaned inner segment of length 21.0141 at centroid (325697.73040492646, 4304206.45329683)
2023-07-19 19:11:44,041 - root - INFO: Simplifying HUCs
2023-07-19 19:11:44,052 - root - INFO: Snapping river and HUC (nearly) coincident nodes
2023-07-19 19:11:44,072 - root - INFO:   snapping polygon segment boundaries to river endpoints
2023-07-19 19:11:44,114 - root - INFO:   snapping river endpoints to the polygon
2023-07-19 19:11:44,125 - root - INFO:     snapped river: (328465.26966356474, 4305018.937609363) to (328464.3780581458, 4305011.855525184)
2023-07-19 19:11:44,150 - root - INFO:   - snapped river: (328465.26966356474, 4305018.937609363) to (328464.3780581458, 4305011.855525184)
2023-07-19 19:11:44,166 - root - INFO:   - snapped river: (328465.26966356474, 4305018.937609363) to (328464.3780581458, 4305011.855525184)
2023-07-19 19:11:44,462 - root - INFO:   cutting at crossings
2023-07-19 19:11:44,467 - root - INFO: intersection found
2023-07-19 19:11:44,523 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,527 - root - INFO:       split HUC boundary seg into 2 pieces
2023-07-19 19:11:44,532 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,541 - root - INFO: intersection found
2023-07-19 19:11:44,551 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,554 - root - INFO:       split HUC boundary seg into 1 pieces
2023-07-19 19:11:44,558 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,573 - root - INFO: intersection found
2023-07-19 19:11:44,585 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,589 - root - INFO:       split HUC boundary seg into 1 pieces
2023-07-19 19:11:44,592 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,617 - root - INFO: intersection found
2023-07-19 19:11:44,672 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,676 - root - INFO:       split HUC boundary seg into 2 pieces
2023-07-19 19:11:44,680 - root - INFO:       split reach seg into 2 pieces
2023-07-19 19:11:44,704 - root - INFO: Cutting crossings and removing external segments
2023-07-19 19:11:44,708 - root - INFO:   cutting at crossings
2023-07-19 19:11:44,713 - root - INFO: intersection found
2023-07-19 19:11:44,724 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,728 - root - INFO:       split HUC boundary seg into 1 pieces
2023-07-19 19:11:44,731 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,745 - root - INFO: intersection found
2023-07-19 19:11:44,755 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,758 - root - INFO:       split HUC boundary seg into 1 pieces
2023-07-19 19:11:44,761 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,774 - root - INFO: intersection found
2023-07-19 19:11:44,787 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,791 - root - INFO:       split HUC boundary seg into 1 pieces
2023-07-19 19:11:44,794 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,821 - root - INFO: intersection found
2023-07-19 19:11:44,834 - root - INFO:   - cutting reach at external boundary of HUCs:
2023-07-19 19:11:44,837 - root - INFO:       split HUC boundary seg into 1 pieces
2023-07-19 19:11:44,840 - root - INFO:       split reach seg into 1 pieces
2023-07-19 19:11:44,862 - root - INFO: 
2023-07-19 19:11:44,866 - root - INFO: Simplification Diagnostics
2023-07-19 19:11:44,869 - root - INFO: ------------------------------
2023-07-19 19:11:44,893 - root - INFO:   river min seg length: 63.505778633192975
2023-07-19 19:11:44,901 - root - INFO:   river median seg length: 165.69096496550588
2023-07-19 19:11:44,913 - root - INFO:   HUC min seg length: 0.0
2023-07-19 19:11:44,919 - root - INFO:   HUC median seg length: 63.75381709415594
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot what we have so far -- an image of the HUC and its stream network</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<img alt="../_images/a78d8029062d9436f69e14131d8b5248bfb65c2a4343c6f1b3df3ce744508847.png" src="../_images/a78d8029062d9436f69e14131d8b5248bfb65c2a4343c6f1b3df3ce744508847.png" />
</div>
</div>
<section id="meshing">
<h3>Meshing<a class="headerlink" href="#meshing" title="Permalink to this heading">#</a></h3>
<p>Triangulation refinement: refine triangles if their area (in m^2) is greater than A(d), where d is the distance from the triangle centroid to the nearest stream. A(d) is a piecewise linear function – A = A0 if d &lt;= d0, A = A1 if d &gt;= d1, and linearly interpolates between the two endpoints.</p>
<p>Adjust distance and area parameters to refine triangles.</p>
<p><span style="color:blue;"> Be careful with the min triangular area (e.g., &lt;1 m^2) in the meshes. It will likely cause the model to run extremely slowly. You may also receive an error saying the tolerance value (i.e., the minimum node distance) is too small.</span> You can increase the smoothing parameter such as <code class="docutils literal notranslate"><span class="pre">simplify_hucs</span></code> or <code class="docutils literal notranslate"><span class="pre">simplify_rivers</span></code> to make the boundaries smoother and meshes coarser.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># form a triangulation on the shape + river network</span>

<span class="c1"># triangulation refinement:</span>
<span class="c1"># Refine triangles if their area (in m^2) is greater than A(d), where d is the </span>
<span class="c1"># distance from the triangle centroid to the nearest stream.</span>
<span class="c1"># A(d) is a piecewise linear function -- A = A0 if d &lt;= d0, A = A1 if d &gt;= d1, and</span>
<span class="c1"># linearly interpolates between the two endpoints.</span>
<span class="n">d0</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">d1</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># distance in meters</span>
<span class="n">A0</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">A1</span> <span class="o">=</span> <span class="mi">50000</span> <span class="c1"># triangular area in m^2</span>
<span class="c1">#A0 = 500; A1 = 2500</span>
<span class="c1">#A0 = 100; A1 = 500</span>

<span class="c1"># Refine triangles if they get too acute</span>
<span class="n">min_angle</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># degrees</span>

<span class="c1"># make 2D mesh</span>
<span class="n">mesh_points2</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">rivers</span><span class="p">,</span> 
                                               <span class="n">refine_distance</span><span class="o">=</span><span class="p">[</span><span class="n">d0</span><span class="p">,</span><span class="n">A0</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">A1</span><span class="p">],</span>
                                               <span class="n">refine_min_angle</span><span class="o">=</span><span class="n">min_angle</span><span class="p">,</span>
                                               <span class="n">diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:11:46,599 - root - INFO: 
2023-07-19 19:11:46,603 - root - INFO: Meshing
2023-07-19 19:11:46,606 - root - INFO: ------------------------------
2023-07-19 19:11:46,644 - root - INFO: Triangulating...
2023-07-19 19:11:46,654 - root - INFO:    98 points and 98 facets
2023-07-19 19:11:46,657 - root - INFO:  checking graph consistency
2023-07-19 19:11:46,662 - root - INFO:  tolerance is set to 1
2023-07-19 19:11:46,676 - root - INFO:  building graph data structures
2023-07-19 19:11:46,690 - root - INFO:  triangle.build...
2023-07-19 19:11:57,261 - root - INFO:   ...built: 2897 mesh points and 5610 triangles
2023-07-19 19:11:57,265 - root - INFO: Plotting triangulation diagnostics
2023-07-19 19:12:00,683 - root - INFO:   min area = 1569.3751220703125
2023-07-19 19:12:00,687 - root - INFO:   max area = 49649.99279785156
</pre></div>
</div>
<img alt="../_images/e8df127b8089639c13a6c406c17a89ceb5aab0fcd0e2656975b6adaabc8efa84.png" src="../_images/e8df127b8089639c13a6c406c17a89ceb5aab0fcd0e2656975b6adaabc8efa84.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get a raster for the elevation map, based on NED</span>
<span class="n">dem_profile</span><span class="p">,</span> <span class="n">dem</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_raster_on_shape</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;DEM&#39;</span><span class="p">],</span> <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">)</span>

<span class="c1"># elevate the triangle nodes to the dem</span>
<span class="n">mesh_points3</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">elevate</span><span class="p">(</span><span class="n">mesh_points2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">dem</span><span class="p">,</span> <span class="n">dem_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:12:02,739 - root - INFO: 
2023-07-19 19:12:02,743 - root - INFO: Loading Raster
2023-07-19 19:12:02,748 - root - INFO: ------------------------------
2023-07-19 19:12:02,751 - root - INFO: Collecting raster
2023-07-19 19:12:02,768 - root - INFO: Collecting DEMs to tile bounds: [-107.11634327399999, 38.817702882000034, -106.96736783099998, 38.90466788700003]
2023-07-19 19:12:02,775 - root - INFO:   Need:
2023-07-19 19:12:02,778 - root - INFO:     /home/jovyan/data/dem/USGS_NED_1as_n39_w108.tif
2023-07-19 19:12:02,782 - root - INFO:     /home/jovyan/data/dem/USGS_NED_1as_n39_w107.tif
2023-07-19 19:12:02,790 - root - INFO: source files already exist!
2023-07-19 19:12:03,009 - root - INFO: ... got raster of shape: (313, 536)
2023-07-19 19:12:03,018 - root - INFO: ... got raster bounds: (-107.11634327399999, 38.90466788700003, -106.96745438510615, 38.81772344247477)
</pre></div>
</div>
</div>
</div>
<p>Plotting the resulting mesh can be done in a variety of ways, including both 3D plots and mapview.  We show both here, but hereafter use mapview plots as they are a bit clearer (if not so flashy)…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the resulting surface mesh</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize_3d</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.23</span><span class="p">,</span><span class="mf">0.18</span><span class="p">,</span><span class="mf">0.58</span><span class="p">,</span><span class="mf">0.03</span><span class="p">])</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> 
                     <span class="n">triangles</span><span class="o">=</span><span class="n">mesh_tris</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
                     <span class="n">edgecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">.2</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;elevation [m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Text(4299000.0, 0, &#39;&#39;),
 Text(4300000.0, 0, &#39;&#39;),
 Text(4301000.0, 0, &#39;&#39;),
 Text(4302000.0, 0, &#39;&#39;),
 Text(4303000.0, 0, &#39;&#39;),
 Text(4304000.0, 0, &#39;&#39;),
 Text(4305000.0, 0, &#39;&#39;),
 Text(4306000.0, 0, &#39;&#39;),
 Text(4307000.0, 0, &#39;&#39;),
 Text(4308000.0, 0, &#39;&#39;)]
</pre></div>
</div>
<img alt="../_images/046df052da5db682f7b4d67e1b037716a6a7b70abe83b6f0e55db5191e657c6a.png" src="../_images/046df052da5db682f7b4d67e1b037716a6a7b70abe83b6f0e55db5191e657c6a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the resulting surface mesh</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.8</span><span class="p">])</span>
<span class="c1">#ax2 = workflow.plot.get_ax(crs,fig, window=[0.65,0.05,0.3,0.5])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">0.58</span><span class="p">,</span><span class="mf">0.10</span><span class="p">,</span><span class="mf">0.15</span><span class="p">,</span><span class="mf">0.15</span><span class="p">])</span>
<span class="n">cbax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">.85</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.03</span><span class="p">,</span><span class="mf">0.6</span><span class="p">])</span>

<span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="mf">320500.</span><span class="p">,</span> <span class="mf">321000.</span><span class="p">)</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4302000.</span><span class="p">,</span> <span class="mf">4302500.</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbax</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;datalim&#39;</span><span class="p">)</span>

<span class="n">mp2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;datalim&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">indicate_inset_zoom</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="c1"># add scalebar, use 1 for UTM coordinates, the default unit is &quot;m&quot;</span>
<span class="c1"># scalebar1 = ScaleBar(1, location = &quot;lower left&quot;, pad=3, frameon=False)</span>
<span class="c1"># ax.add_artist(scalebar1)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation [m]&#39;</span><span class="p">)</span>
<span class="c1"># fig.savefig(&#39;../figures/watershed_mesh-2d.jpg&#39;,dpi=300)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316658.3121175361, 329703.25353174284)
(4296859.719285354, 4309904.660699561)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Elevation [m]&#39;)
</pre></div>
</div>
<img alt="../_images/5122b35670861e62fa18e082b6be0a170f87450fe7265fba38f2c6fea5955e12.png" src="../_images/5122b35670861e62fa18e082b6be0a170f87450fe7265fba38f2c6fea5955e12.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the 2D mesh</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh2D</span><span class="p">(</span><span class="n">mesh_points3</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(</span><span class="n">mesh_tris</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Condition the mesh to remove pits and ponds in the meshes. <span style="color:blue;">Advanced tip: use <code class="docutils literal notranslate"><span class="pre">fill_pits_dual(m2,</span> <span class="pre">is_waterbody=waterbody_mask)</span> </code> if there exists lakes or reservoirs where pits should not be removed! </span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># hydrologically condition the mesh, removing pits</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">condition</span><span class="o">.</span><span class="n">fill_pits</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span>

<span class="c1"># plot the change between the two meshes</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">)</span>
<span class="n">diff</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max diff = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> 
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;conditioned dz&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>max diff =  93.59001668278142
</pre></div>
</div>
<img alt="../_images/d817f10b00e75c973780e6d7efffbc317a8c21806d4f05229e6225188ddff52e.png" src="../_images/d817f10b00e75c973780e6d7efffbc317a8c21806d4f05229e6225188ddff52e.png" />
</div>
</div>
</section>
<section id="add-watershed-outlet-optional">
<h3>Add watershed outlet (optional)<a class="headerlink" href="#add-watershed-outlet-optional" title="Permalink to this heading">#</a></h3>
<p>This will add the outlet region in the mesh for better capturing the streamflow in post-processing. Here there is only one catchment with one outlet. However, this may be necessary for watershed with multiple subcatchments with multiple outlets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">watershed</span><span class="o">.</span><span class="n">polygons</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OrderedDict([(&#39;OBJECTID&#39;, 11223.0),
             (&#39;TNMID&#39;, &#39;{C3DA8896-4FF3-4B2F-A382-3B4AFDC6D77E}&#39;),
             (&#39;METASOURCE&#39;, None),
             (&#39;SOURCEDATA&#39;, None),
             (&#39;SOURCEORIG&#39;, None),
             (&#39;SOURCEFEAT&#39;, None),
             (&#39;LOADDATE&#39;, &#39;2013/01/18 07:08:08.000&#39;),
             (&#39;GNIS_ID&#39;, None),
             (&#39;AREAACRES&#39;, 13146.76),
             (&#39;AREASQKM&#39;, 53.2),
             (&#39;STATES&#39;, &#39;CO&#39;),
             (&#39;HUC12&#39;, &#39;140200010204&#39;),
             (&#39;NAME&#39;, &#39;Coal Creek&#39;),
             (&#39;HUTYPE&#39;, &#39;S&#39;),
             (&#39;HUMOD&#39;, &#39;NM&#39;),
             (&#39;TOHUC&#39;, &#39;140200010205&#39;),
             (&#39;NONCONTRIB&#39;, 0.0),
             (&#39;NONCONTR_1&#39;, 0.0),
             (&#39;Shape_Leng&#39;, 0.357147902089145),
             (&#39;Shape_Area&#39;, 0.005521609626425)])
</pre></div>
</div>
</div>
</div>
<p>Identify outlets for each catchment. Plot the outlets to verify the correct outlet locations.</p>
<p>Available functions to find the outlets include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">find_outlets_by_crossings()</span></code>: find all outlets using river network’s crossing points on HUC boundary. This may not work well if river has multiple crossings on the same boundary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">find_outlets_by_elevation()</span></code>: find all outlets by the minimum elevation. This does not work if the minimum elevation within the watershed is not located at the outlet.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">find_outlets_by_hydroseq()</span></code>: find outlets using the HydroSequence VAA of NHDPlus. This may take a while.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">watershed_workflow</span><span class="o">.</span><span class="n">split_hucs</span><span class="o">.</span><span class="n">find_outlets_by_elevation</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">dem</span><span class="p">,</span> <span class="n">dem_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add labeled sets for subcatcprojectnts and outlets. </span>
<span class="c1"># Here we use HUC12 code, but any other labels would work.</span>
<span class="n">outlet_width</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># half-width (unit is the same as in watershed CRS) to track a labeled set on which to get discharge. Use large values to be conservative.</span>
<span class="n">watershed_polygons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">watershed</span><span class="o">.</span><span class="n">polygons</span><span class="p">())</span>
<span class="n">catchment_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;HUC12&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">watershed_polygons</span><span class="p">]</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">add_watershed_regions_and_outlets</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">watershed</span><span class="p">,</span> 
                                                <span class="n">outlet_width</span><span class="o">=</span><span class="n">outlet_width</span><span class="p">,</span> 
                                               <span class="n">labels</span><span class="o">=</span><span class="n">catchment_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot outlets</span>
<span class="c1"># fig,ax=plt.subplots(1,1,figsize=(6,4))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">watershed</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">outlet_marker</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8f637fea7e5c679e36f2aba5cfa747fba5e5eb9d35f64ad0368ac6b0bbb76332.png" src="../_images/8f637fea7e5c679e36f2aba5cfa747fba5e5eb9d35f64ad0368ac6b0bbb76332.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">labeled_sets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">setid</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">entity</span><span class="si">}</span><span class="s1"> : &quot;</span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10000 : CELL : &quot;140200010204&quot;
10001 : CELL : &quot;140200010204 surface&quot;
10002 : FACE : &quot;140200010204 boundary&quot;
10003 : FACE : &quot;140200010204 outlet&quot;
10004 : FACE : &quot;surface domain outlet&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;catchment_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catchment_labels</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="surface-properties">
<h2>Surface properties<a class="headerlink" href="#surface-properties" title="Permalink to this heading">#</a></h2>
<p>Meshes interact with data to provide forcing, parameters, and more in the actual simulation.  Specifically, we need vegetation type on the surface to provide information about transpiration and subsurface structure to provide information about water retention curves, etc.</p>
<p>We’ll start by downloading and collecting land cover from the NLCD dataset, and generate sets for each land cover type that cover the surface.  Likely these will be some combination of grass, deciduous forest, coniferous forest, and mixed.</p>
<section id="land-cover">
<h3>Land Cover<a class="headerlink" href="#land-cover" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the NLCD raster</span>
<span class="n">lc_profile</span><span class="p">,</span> <span class="n">lc_raster</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_raster_on_shape</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;land cover&#39;</span><span class="p">],</span> 
                                                     <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">)</span>

<span class="c1"># resample the raster to the triangles</span>
<span class="n">lc</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">lc_raster</span><span class="p">,</span> <span class="n">lc_profile</span><span class="p">)</span>

<span class="c1"># what land cover types did we get?</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found land cover dtypes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found land cover types: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lc</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:12:18,507 - root - INFO: 
2023-07-19 19:12:18,511 - root - INFO: Loading Raster
2023-07-19 19:12:18,516 - root - INFO: ------------------------------
2023-07-19 19:12:18,522 - root - INFO: Collecting raster
2023-07-19 19:12:19,365 - root - INFO: bounds in my_crs: (-952551.1064432578, 1811083.3381282836, -941371.5911290408, 1818385.78533155)
2023-07-19 19:12:19,425 - root - INFO: ... got raster of shape: (245, 374)
2023-07-19 19:12:20,044 - root - INFO: ... got raster bounds: (-952575.0, 1818405.0, -941355.0, 1811055.0)
2023-07-19 19:12:21,326 - root - INFO: Found land cover dtypes: uint8
2023-07-19 19:12:21,336 - root - INFO: Found land cover types: {71, 41, 42, 43, 11, 81, 52, 21, 22, 23, 24, 90, 31, 95}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the NLCD data</span>

<span class="c1"># -- get the NLCD colormap which uses official NLCD colors and labels</span>
<span class="n">nlcd_indices</span><span class="p">,</span> <span class="n">nlcd_cmap</span><span class="p">,</span> <span class="n">nlcd_norm</span><span class="p">,</span> <span class="n">nlcd_ticks</span><span class="p">,</span> <span class="n">nlcd_labels</span> <span class="o">=</span> \
                <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_nlcd_colormap</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

<span class="c1"># plot the image</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">polys</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">nlcd_cmap</span><span class="p">,</span> 
                                     <span class="n">norm</span><span class="o">=</span><span class="n">nlcd_norm</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                                     <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nlcd_indices</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">nlcd_cmap</span><span class="p">,</span> 
                                         <span class="n">labels</span><span class="o">=</span><span class="n">nlcd_labels</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NLCD land cover index&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x4095163d30&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x4095162e60&gt;, &#39;edgecolor&#39;: &#39;none&#39;, &#39;linewidth&#39;: 0.5}
setting face color =  [95 21 42 ... 52 42 42]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/9e84d06bcd69782f148e9d224d22f41f42d8386d7a0e95c6f08d1e34fcd5a4cb.png" src="../_images/9e84d06bcd69782f148e9d224d22f41f42d8386d7a0e95c6f08d1e34fcd5a4cb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlcd_indices</span><span class="p">,</span> <span class="n">nlcd_labels</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([11, 21, 22, 23, 24, 31, 41, 42, 43, 52, 71, 81, 90, 95],
 [&#39;Open Water&#39;,
  &#39;Developed, Open Space&#39;,
  &#39;Developed, Low Intensity&#39;,
  &#39;Developed, Medium Intensity&#39;,
  &#39;Developed, High Intensity&#39;,
  &#39;Barren Land&#39;,
  &#39;Deciduous Forest&#39;,
  &#39;Evergreen Forest&#39;,
  &#39;Mixed Forest&#39;,
  &#39;Shrub/Scrub&#39;,
  &#39;Grassland/Herbaceous&#39;,
  &#39;Pasture/Hay&#39;,
  &#39;Woody Wetlands&#39;,
  &#39;Emergent Herbaceous Wetlands&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # add labeled sets to the mesh for NLCD</span>
<span class="c1"># nlcd_labels_dict = dict(zip(nlcd_indices, nlcd_labels))</span>
<span class="c1"># watershed_workflow.mesh.add_nlcd_labeled_sets(m2, lc, nlcd_labels_dict)</span>

<span class="c1"># for ls in m2.labeled_sets:</span>
<span class="c1">#     print(f&#39;{ls.setid} : {ls.entity} : &quot;{ls.name}&quot;&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="lai">
<h3>LAI<a class="headerlink" href="#lai" title="Permalink to this heading">#</a></h3>
<p>Download MODIS LAI and LULC, block until it is finished!
NOTE: if you get an error here about MODIS AppEEARs username and password, realize that you must register for a login in the AppEEARs database.  See: <code class="docutils literal notranslate"><span class="pre">print(sources['lai'].__doc__)</span></code></p>
<p>You may encounter download issues if the files are too big. In that case, manually download the MODIS data using <a class="reference external" href="https://appeears.earthdatacloud.nasa.gov/">AppEEARS</a>. Here are brief steps:</p>
<ol class="arabic simple">
<li><p>Sign in if you already registered.</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Extract</span> <span class="pre">--&gt;</span> <span class="pre">Area</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">a</span> <span class="pre">new</span> <span class="pre">request</span></code></p></li>
<li><p>Upload the watershed shapefile (in lat-lon). <span style="color:blue;"> Important: draw a box region surrounding the watershed to avoid downloading no_data! </span></p></li>
<li><p>Choose <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Date</span></code> (e.g., 2002-7-1) and <code class="docutils literal notranslate"><span class="pre">End</span> <span class="pre">Date</span></code> (e.g., 2021-1-1)</p></li>
<li><p>Select product for Landcover (e.g., <code class="docutils literal notranslate"><span class="pre">MCD12Q1.006</span></code>) or LAI (e.g., <code class="docutils literal notranslate"><span class="pre">MCD15A3H.006</span></code>)</p></li>
<li><p>Select layers or for landcover (i.e., <code class="docutils literal notranslate"><span class="pre">LC_Type1</span></code>) or LAI (i.e., <code class="docutils literal notranslate"><span class="pre">Lai_500m</span></code>). You may choose to include all layers, but not all will be used.</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">NetCDF-4</span></code> as the output file format</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Submit</span></code>. It will send an email after download is completed.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Uncomment the next three lines if you want to try downloading through WW</span>
<span class="c1"># modis = sources[&#39;lai&#39;].get_data(watershed.exterior(), crs, start, end)</span>
<span class="c1"># if not isinstance(modis, watershed_workflow.datasets.State):</span>
<span class="c1">#     modis = sources[&#39;lai&#39;].wait(modis)</span>
<span class="n">modis</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;lai&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">,</span> <span class="s1">&#39;LAI&#39;</span><span class="p">],</span> <span class="n">filenames</span><span class="o">=</span><span class="p">[</span><span class="n">watershed_modis_lulc</span><span class="p">,</span> <span class="n">watershed_modis_lai</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:12:30,202 - root - INFO: ... reading LULC from ../../data/examples/CoalCreek/sources/land_cover/MODIS/MCD12Q1.006_500m_aid0001.nc
2023-07-19 19:12:30,329 - root - INFO: ... reading LAI from ../../data/examples/CoalCreek/sources/land_cover/MODIS/MCD15A3H.006_500m_aid0001.nc
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">times</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([datetime.date(2002, 1, 1), datetime.date(2003, 1, 1),
       datetime.date(2004, 1, 1), datetime.date(2005, 1, 1),
       datetime.date(2006, 1, 1), datetime.date(2007, 1, 1),
       datetime.date(2008, 1, 1), datetime.date(2009, 1, 1),
       datetime.date(2010, 1, 1), datetime.date(2011, 1, 1),
       datetime.date(2012, 1, 1), datetime.date(2013, 1, 1),
       datetime.date(2014, 1, 1), datetime.date(2015, 1, 1),
       datetime.date(2016, 1, 1), datetime.date(2017, 1, 1),
       datetime.date(2018, 1, 1), datetime.date(2019, 1, 1),
       datetime.date(2020, 1, 1)], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select the year of 2016 for MODIS landcover to match 2016 NLCD land cover</span>
<span class="n">lc_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">times</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lc_idx</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># resample the raster to the triangles</span>
<span class="n">modis_lc</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">lc_idx</span><span class="p">,:,:],</span> 
                                                 <span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

<span class="c1"># what land cover types did we get?</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found land cover dtypes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modis_lc</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found land cover types: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">modis_lc</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:12:30,978 - root - INFO: Found land cover dtypes: int16
2023-07-19 19:12:30,985 - root - INFO: Found land cover types: {8, 9, 10, 1}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the modis lulc data</span>

<span class="c1"># -- get the MODIS colormap which uses official MODIS colors and labels</span>
<span class="n">modis_indices</span><span class="p">,</span> <span class="n">modis_cmap</span><span class="p">,</span> <span class="n">modis_norm</span><span class="p">,</span> <span class="n">modis_ticks</span><span class="p">,</span> <span class="n">modis_labels</span> <span class="o">=</span> \
                <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_modis_colormap</span><span class="p">(</span><span class="n">modis_lc</span><span class="p">)</span>

<span class="c1"># plot the image</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">polys</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">modis_lc</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">modis_cmap</span><span class="p">,</span> 
                                     <span class="n">norm</span><span class="o">=</span><span class="n">modis_norm</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                                     <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">modis_indices</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">modis_cmap</span><span class="p">,</span> 
                                         <span class="n">labels</span><span class="o">=</span><span class="n">modis_labels</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MODIS land cover index&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x4095a37880&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x4095a370d0&gt;, &#39;edgecolor&#39;: &#39;none&#39;, &#39;linewidth&#39;: 0.5}
setting face color =  [ 9 10  9 ...  8  9  8]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/519405b65fb9976d06f4b8054c1c30218d6dca2a059fa8dabe6f8bb4e1981f37.png" src="../_images/519405b65fb9976d06f4b8054c1c30218d6dca2a059fa8dabe6f8bb4e1981f37.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># determine a crosswalk between NLCD and MODIS -- for each NLCD index, </span>
<span class="c1"># what MODIS index correlates best.  </span>
<span class="n">unique_nlcd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lc</span><span class="p">))</span>
<span class="n">unique_modis</span> <span class="o">=</span> <span class="n">modis_indices</span>

<span class="n">crosswalk</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">land_cover_properties</span><span class="o">.</span><span class="n">compute_crosswalk_correlation</span><span class="p">(</span>
    <span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">lc_idx</span><span class="p">,:,:],</span> <span class="n">lc_profile</span><span class="p">,</span> <span class="n">lc_raster</span><span class="p">,</span> <span class="n">unique_nlcd</span> <span class="o">=</span> <span class="n">unique_nlcd</span><span class="p">,</span> <span class="n">unique_modis</span><span class="o">=</span><span class="n">unique_modis</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8e71f19dffe4fabc4806c83a6439024a8349469652f101957c126e29cbecbf47.png" src="../_images/8e71f19dffe4fabc4806c83a6439024a8349469652f101957c126e29cbecbf47.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print the crosswalk.</span>
<span class="n">crosswalk</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{11: 10,
 21: 8,
 22: 9,
 23: 10,
 24: 10,
 31: 8,
 41: 10,
 42: 8,
 43: 10,
 52: 10,
 71: 10,
 81: 10,
 90: 9,
 95: 10}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlcd_color_new</span> <span class="o">=</span> <span class="mi">99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">crosswalk</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># for label in v:</span>
    <span class="c1"># index = sources[&#39;land cover&#39;].indices[label]</span>
    <span class="n">nlcd_color_new</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lc</span> <span class="o">==</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nlcd_color_new</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 8,  9, 10], dtype=uint8)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot new NLCD data</span>

<span class="c1"># -- get the NLCD colormap which uses official NLCD colors and labels</span>
<span class="n">nlcd_indices_new</span><span class="p">,</span> <span class="n">nlcd_cmap_new</span><span class="p">,</span> <span class="n">nlcd_norm_new</span><span class="p">,</span> <span class="n">nlcd_ticks_new</span><span class="p">,</span> <span class="n">nlcd_labels_new</span> <span class="o">=</span> \
                <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_modis_colormap</span><span class="p">(</span><span class="n">nlcd_color_new</span><span class="p">)</span>

<span class="c1"># plot the image</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">polys</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">nlcd_color_new</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">nlcd_cmap_new</span><span class="p">,</span> 
                                     <span class="n">norm</span><span class="o">=</span><span class="n">nlcd_norm_new</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                                     <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nlcd_indices_new</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">nlcd_cmap_new</span><span class="p">,</span> 
                                         <span class="n">labels</span><span class="o">=</span><span class="n">nlcd_labels_new</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;New land cover index&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x4095b28640&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x4095b2ad10&gt;, &#39;edgecolor&#39;: &#39;none&#39;, &#39;linewidth&#39;: 0.5}
setting face color =  [10  8  8 ... 10  8  8]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/f406207dd5a3ebd193b4d0be9fc982b566e0c0dabbb1898cd516c0b6a0fc59fb.png" src="../_images/f406207dd5a3ebd193b4d0be9fc982b566e0c0dabbb1898cd516c0b6a0fc59fb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlcd_indices_new</span><span class="p">,</span> <span class="n">nlcd_labels_new</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([8, 9, 10], [&#39;Woody Savannas&#39;, &#39;Savannas&#39;, &#39;Grasslands&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add labeled sets to the mesh for new NLCD</span>
<span class="n">nlcd_labels_new</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MODIS &#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nlcd_labels_new</span><span class="p">]</span>
<span class="n">nlcd_labels_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nlcd_indices_new</span><span class="p">,</span> <span class="n">nlcd_labels_new</span><span class="p">))</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">add_nlcd_labeled_sets</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">nlcd_color_new</span><span class="p">,</span> <span class="n">nlcd_labels_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nlcd_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nlcd_indices_new</span><span class="p">]</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;nlcd_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlcd_labels_new</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">labeled_sets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">setid</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">entity</span><span class="si">}</span><span class="s1"> : &quot;</span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10000 : CELL : &quot;140200010204&quot;
10001 : CELL : &quot;140200010204 surface&quot;
10002 : FACE : &quot;140200010204 boundary&quot;
10003 : FACE : &quot;140200010204 outlet&quot;
10004 : FACE : &quot;surface domain outlet&quot;
8 : CELL : &quot;MODIS Woody Savannas&quot;
9 : CELL : &quot;MODIS Savannas&quot;
10 : CELL : &quot;MODIS Grasslands&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute area averaged LAI for each modis land cover</span>
<span class="n">lai_time_series</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">land_cover_properties</span><span class="o">.</span><span class="n">compute_time_series</span><span class="p">(</span>
<span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LAI&#39;</span><span class="p">],</span> <span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">],</span> <span class="n">unique_lc</span> <span class="o">=</span> <span class="n">unique_modis</span><span class="p">,</span> <span class="n">lc_idx</span> <span class="o">=</span> <span class="n">lc_idx</span><span class="p">)</span>
<span class="n">lai_time_series</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time [datetime]</th>
      <th>MODIS Evergreen Needleleaf Forests LAI [-]</th>
      <th>MODIS Woody Savannas LAI [-]</th>
      <th>MODIS Savannas LAI [-]</th>
      <th>MODIS Grasslands LAI [-]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2002-07-04</td>
      <td>1.589855</td>
      <td>1.616497</td>
      <td>1.184228</td>
      <td>1.017632</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2002-07-08</td>
      <td>1.847826</td>
      <td>1.639086</td>
      <td>1.178188</td>
      <td>0.983158</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2002-07-12</td>
      <td>2.168116</td>
      <td>1.817005</td>
      <td>1.337584</td>
      <td>1.112895</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2002-07-16</td>
      <td>2.186957</td>
      <td>2.015482</td>
      <td>1.410403</td>
      <td>1.103158</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2002-07-20</td>
      <td>1.518841</td>
      <td>1.466751</td>
      <td>0.984228</td>
      <td>0.865000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1694</th>
      <td>2020-12-18</td>
      <td>0.957971</td>
      <td>0.845431</td>
      <td>0.350671</td>
      <td>0.200789</td>
    </tr>
    <tr>
      <th>1695</th>
      <td>2020-12-22</td>
      <td>0.563768</td>
      <td>0.481980</td>
      <td>0.199664</td>
      <td>0.102895</td>
    </tr>
    <tr>
      <th>1696</th>
      <td>2020-12-26</td>
      <td>0.556522</td>
      <td>0.356853</td>
      <td>0.145302</td>
      <td>0.073158</td>
    </tr>
    <tr>
      <th>1697</th>
      <td>2020-12-30</td>
      <td>0.602899</td>
      <td>0.407107</td>
      <td>0.200671</td>
      <td>0.087632</td>
    </tr>
    <tr>
      <th>1698</th>
      <td>2021-01-01</td>
      <td>0.947826</td>
      <td>0.579695</td>
      <td>0.160738</td>
      <td>0.090000</td>
    </tr>
  </tbody>
</table>
<p>1699 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot LAI</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">lai_time_series</span><span class="p">[</span><span class="s1">&#39;time [datetime]&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="n">lai_time_series</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">lai_time_series</span><span class="p">[</span><span class="n">icol</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">icol</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;LAI [-]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x4095141c60&gt;
</pre></div>
</div>
<img alt="../_images/546452b8f7782c5e009927750ee5164e2b1b60912a81bab61e288674d865821d.png" src="../_images/546452b8f7782c5e009927750ee5164e2b1b60912a81bab61e288674d865821d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># write raw LAI to disk</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;LAI_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">,</span> <span class="s1">&#39;CoalCreek&#39;</span><span class="p">,</span> <span class="s1">&#39;processed&#39;</span><span class="p">,</span> <span class="s1">&#39;watershed_lai_raw.h5&#39;</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_timeseries_to_hdf5</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LAI_filename&#39;</span><span class="p">],</span> <span class="n">lai_time_series</span><span class="p">,</span> 
                                              <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;MODIS LAI based on MODIS LULC&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">},</span> <span class="n">time0</span><span class="o">=</span><span class="n">origin_date</span><span class="p">)</span>                                            
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:12:53,160 - root - INFO: Writing HDF5 file: ../../data/examples/CoalCreek/processed/watershed_lai_raw.h5
</pre></div>
</div>
</div>
</div>
<p>Generate smoothed MODIS LAI data for spinup runs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute area averaged LAI for each modis land cover</span>
<span class="n">lai_time_series_smoothed</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">land_cover_properties</span><span class="o">.</span><span class="n">compute_time_series</span><span class="p">(</span>
<span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LAI&#39;</span><span class="p">],</span> <span class="n">modis</span><span class="p">[</span><span class="s1">&#39;LULC&#39;</span><span class="p">],</span> <span class="n">unique_lc</span> <span class="o">=</span> <span class="n">unique_modis</span><span class="p">,</span> <span class="n">lc_idx</span> <span class="o">=</span> <span class="n">lc_idx</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lai_time_series_smoothed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time [datetime]</th>
      <th>MODIS Evergreen Needleleaf Forests LAI [-]</th>
      <th>MODIS Woody Savannas LAI [-]</th>
      <th>MODIS Savannas LAI [-]</th>
      <th>MODIS Grasslands LAI [-]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2002-07-04</td>
      <td>1.626218</td>
      <td>1.615882</td>
      <td>1.185884</td>
      <td>0.996145</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2002-07-05</td>
      <td>1.678844</td>
      <td>1.633757</td>
      <td>1.196320</td>
      <td>1.002076</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2002-07-06</td>
      <td>1.728293</td>
      <td>1.650247</td>
      <td>1.205861</td>
      <td>1.007377</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2002-07-07</td>
      <td>1.774630</td>
      <td>1.665379</td>
      <td>1.214525</td>
      <td>1.012063</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2002-07-08</td>
      <td>1.817918</td>
      <td>1.679181</td>
      <td>1.222327</td>
      <td>1.016144</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>6752</th>
      <td>2020-12-28</td>
      <td>0.675724</td>
      <td>0.490863</td>
      <td>0.192045</td>
      <td>0.093669</td>
    </tr>
    <tr>
      <th>6753</th>
      <td>2020-12-29</td>
      <td>0.671858</td>
      <td>0.495014</td>
      <td>0.192953</td>
      <td>0.093393</td>
    </tr>
    <tr>
      <th>6754</th>
      <td>2020-12-30</td>
      <td>0.667734</td>
      <td>0.499303</td>
      <td>0.193928</td>
      <td>0.093184</td>
    </tr>
    <tr>
      <th>6755</th>
      <td>2020-12-31</td>
      <td>0.663339</td>
      <td>0.503729</td>
      <td>0.194968</td>
      <td>0.093040</td>
    </tr>
    <tr>
      <th>6756</th>
      <td>2021-01-01</td>
      <td>0.658664</td>
      <td>0.508288</td>
      <td>0.196070</td>
      <td>0.092960</td>
    </tr>
  </tbody>
</table>
<p>6757 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot LAI</span>
<span class="n">ilc</span> <span class="o">=</span> <span class="n">lai_time_series</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">lai_time_series</span><span class="p">[</span><span class="s1">&#39;time [datetime]&#39;</span><span class="p">])</span>
<span class="n">new_times</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">lai_time_series_smoothed</span><span class="p">[</span><span class="s1">&#39;time [datetime]&#39;</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">lai_time_series</span><span class="p">[</span><span class="n">ilc</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Raw&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_times</span><span class="p">,</span> <span class="n">lai_time_series_smoothed</span><span class="p">[</span><span class="n">ilc</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Smoothed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;LAI [-]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">ilc</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x4095c63f10&gt;
</pre></div>
</div>
<img alt="../_images/ea708ce4b036a3a5a3f50f5726b718b62c8e4a106955b7188cbce028c07825d2.png" src="../_images/ea708ce4b036a3a5a3f50f5726b718b62c8e4a106955b7188cbce028c07825d2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lai_time_series_smoothed</span><span class="p">[</span><span class="s2">&quot;time [datetime]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">lai_time_series_smoothed</span><span class="p">[</span><span class="s2">&quot;time [datetime]&quot;</span><span class="p">])</span>
<span class="n">lai_time_series_smoothed</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time [datetime]&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lai_avg</span><span class="o">=</span><span class="n">lai_time_series_smoothed</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">lai_time_series_smoothed</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">lai_time_series_smoothed</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">lai_avg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;time [datetime],time [datetime]&#39;&gt;
</pre></div>
</div>
<img alt="../_images/0e911ce1558485513c9a4e6ceaa5f176e6d7e4239479e9b7e552bb4e4df8e4ea.png" src="../_images/0e911ce1558485513c9a4e6ceaa5f176e6d7e4239479e9b7e552bb4e4df8e4ea.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># repeat for 40 years</span>
<span class="n">lai_typical</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">lai_avg</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">lai_avg</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">lai_typical</span><span class="p">[</span><span class="s1">&#39;time [s]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATSutils</span><span class="o">.</span><span class="n">sec_noleap</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">lai_typical</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">lai_typical</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MODIS Evergreen Needleleaf Forests LAI [-]</th>
      <th>MODIS Woody Savannas LAI [-]</th>
      <th>MODIS Savannas LAI [-]</th>
      <th>MODIS Grasslands LAI [-]</th>
      <th>time [s]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.624212</td>
      <td>0.380460</td>
      <td>0.151158</td>
      <td>0.075328</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.619714</td>
      <td>0.372474</td>
      <td>0.148457</td>
      <td>0.074082</td>
      <td>86400</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.617371</td>
      <td>0.371603</td>
      <td>0.148243</td>
      <td>0.073763</td>
      <td>172800</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.615117</td>
      <td>0.370879</td>
      <td>0.148019</td>
      <td>0.073519</td>
      <td>259200</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.612984</td>
      <td>0.370297</td>
      <td>0.147774</td>
      <td>0.073339</td>
      <td>345600</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>14595</th>
      <td>0.644767</td>
      <td>0.385057</td>
      <td>0.152636</td>
      <td>0.076993</td>
      <td>1261008000</td>
    </tr>
    <tr>
      <th>14596</th>
      <td>0.641196</td>
      <td>0.383983</td>
      <td>0.152196</td>
      <td>0.076507</td>
      <td>1261094400</td>
    </tr>
    <tr>
      <th>14597</th>
      <td>0.637604</td>
      <td>0.383063</td>
      <td>0.151849</td>
      <td>0.076132</td>
      <td>1261180800</td>
    </tr>
    <tr>
      <th>14598</th>
      <td>0.633966</td>
      <td>0.382276</td>
      <td>0.151593</td>
      <td>0.075871</td>
      <td>1261267200</td>
    </tr>
    <tr>
      <th>14599</th>
      <td>0.630448</td>
      <td>0.381657</td>
      <td>0.151440</td>
      <td>0.075720</td>
      <td>1261353600</td>
    </tr>
  </tbody>
</table>
<p>14600 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># write to disk</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;LAI_typical_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">,</span> <span class="s1">&#39;CoalCreek&#39;</span><span class="p">,</span> <span class="s1">&#39;processed&#39;</span><span class="p">,</span> <span class="s1">&#39;watershed_lai_typical.h5&#39;</span><span class="p">)</span>
<span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;Typical LAI generated MODIS LAI data from </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, averaged for all days across each year, then repeated for 40 years&#39;</span><span class="p">,</span>
           <span class="s1">&#39;origin date&#39;</span><span class="p">:</span><span class="n">origin_date</span><span class="p">}</span>

<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LAI_typical_filename&#39;</span><span class="p">],</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lai_typical</span><span class="p">:</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">lai_typical</span><span class="p">[</span><span class="n">k</span><span class="p">][:])</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="subsurface-properties">
<h2>Subsurface properties<a class="headerlink" href="#subsurface-properties" title="Permalink to this heading">#</a></h2>
<p>Get soil structure from SSURGO.  By soil structure, here we calculate, for each formation identified in SSURGO, a soil depth, porosity, permeability, and percent sand/silt/clay (which are then handed off to Rosetta to get a van Genuchten model).</p>
<p>Below this soil we also identify a geologic layer provided by GLHYMPS.  This provides information about the deeper subsurface.</p>
<section id="ssurgo-soil-properties">
<h3>SSURGO Soil Properties<a class="headerlink" href="#ssurgo-soil-properties" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the NRCS soils data as shapes and project it onto the mesh</span>

<span class="c1"># -- download the shapes</span>
<span class="n">soil_profile</span><span class="p">,</span> <span class="n">soil_survey</span><span class="p">,</span> <span class="n">soil_survey_props</span> <span class="o">=</span> \
        <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;soil structure&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),],</span>
                                      <span class="n">crs</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># -- determine the NRCS mukey for each soil unit; this uniquely identifies soil </span>
<span class="c1">#    properties</span>
<span class="n">soil_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">][:],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    
<span class="c1"># -- color a raster by the polygons (this makes identifying a triangle&#39;s value much </span>
<span class="c1">#    more efficient)</span>
<span class="n">soil_color_profile</span><span class="p">,</span> <span class="n">soil_color_raster</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">color_raster_from_shapes</span><span class="p">(</span><span class="n">soil_survey</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">soil_ids</span><span class="p">,</span>
                                                                                    <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># -- resample the raster to the triangles</span>
<span class="n">soil_color</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> 
                                         <span class="n">soil_color_raster</span><span class="p">,</span> <span class="n">soil_color_profile</span><span class="p">)</span>



<span class="n">soil_color</span> <span class="o">=</span> <span class="n">soil_color</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:12:58,836 - root - INFO: 
2023-07-19 19:12:58,840 - root - INFO: Loading shapes
2023-07-19 19:12:58,842 - root - INFO: ------------------------------
2023-07-19 19:12:58,937 - root - INFO: Attempting to download source for target &#39;/home/jovyan/data/soil_structure/SSURGO/SSURGO_-107.1073_38.8271_-106.9759_38.8957.shp&#39;
2023-07-19 19:12:59,139 - root - INFO:   Found 109 shapes.
2023-07-19 19:12:59,151 - root - INFO:   and crs: epsg:4326
2023-07-19 19:12:59,154 - root - INFO:   Downloaded 109 total shapes
2023-07-19 19:12:59,159 - root - INFO:   Downloaded 32 unique mukeys
2023-07-19 19:12:59,404 - root - INFO: found 32 unique MUKEYs.
2023-07-19 19:13:08,108 - root - INFO: Running Rosetta for van Genutchen parameters
2023-07-19 19:13:08,979 - root - INFO:   ... done
2023-07-19 19:13:08,996 - root - INFO:   requested 28 values
2023-07-19 19:13:08,999 - root - INFO:   got 28 responses
2023-07-19 19:13:09,071 - root - INFO: ... found 32 shapes
2023-07-19 19:13:09,074 - root - INFO: Converting to shapely
2023-07-19 19:13:09,085 - root - INFO: Converting to requested CRS
2023-07-19 19:13:09,303 - root - INFO: Coloring shapes onto raster:
2023-07-19 19:13:09,314 - root - INFO:   of shape: (735, 1124)
2023-07-19 19:13:09,317 - root - INFO:   and 32 independent colors
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the soil mukey</span>
<span class="n">indices</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> \
        <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_indexed_colormap</span><span class="p">(</span><span class="n">soil_color</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.9</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.8</span><span class="p">])</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">soil_color</span><span class="p">,</span> 
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span>
                       <span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">soil_color</span><span class="p">)),</span> 
                                                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;soil type index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;linewidth&#39;: 0, &#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x4095b04d60&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x4095b053c0&gt;}
setting face color =  [509733 509794 509532 ... 509481 509547 509481]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/887cb2563ab1a8d0cf2506ceb51ba27eb535fca2b0d992a9ebd428b70bd729a0.png" src="../_images/887cb2563ab1a8d0cf2506ceb51ba27eb535fca2b0d992a9ebd428b70bd729a0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note this is not just the soil ID, but also soil properties.  </span>
<span class="c1"># print(soil_survey_props.keys())</span>
<span class="n">soil_survey_props</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mukey&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># only select soils within the watershed</span>
<span class="n">soil_survey_props</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">soil_color</span><span class="p">),</span> <span class="p">:]</span>
<span class="n">soil_survey_props</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>residual saturation [-]</th>
      <th>Rosetta porosity [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>Rosetta permeability [m^2]</th>
      <th>thickness [cm]</th>
      <th>permeability [m^2]</th>
      <th>porosity [-]</th>
      <th>bulk density [g/cm^3]</th>
      <th>total sand pct [%]</th>
      <th>total silt pct [%]</th>
      <th>total clay pct [%]</th>
      <th>source</th>
    </tr>
    <tr>
      <th>mukey</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>498185</th>
      <td>0.240269</td>
      <td>0.502882</td>
      <td>0.000092</td>
      <td>1.319916</td>
      <td>3.617805e-13</td>
      <td>152.000000</td>
      <td>2.279759e-13</td>
      <td>0.265563</td>
      <td>1.207632</td>
      <td>32.946001</td>
      <td>24.529703</td>
      <td>42.524296</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>498205</th>
      <td>0.181598</td>
      <td>0.399993</td>
      <td>0.000139</td>
      <td>1.457559</td>
      <td>4.938634e-13</td>
      <td>152.000000</td>
      <td>2.734080e-12</td>
      <td>0.159737</td>
      <td>1.413553</td>
      <td>63.518421</td>
      <td>22.988158</td>
      <td>13.493421</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>498206</th>
      <td>0.181598</td>
      <td>0.399993</td>
      <td>0.000139</td>
      <td>1.457559</td>
      <td>4.938634e-13</td>
      <td>152.000000</td>
      <td>2.734080e-12</td>
      <td>0.159737</td>
      <td>1.413553</td>
      <td>63.518421</td>
      <td>22.988158</td>
      <td>13.493421</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>498208</th>
      <td>0.208316</td>
      <td>0.428990</td>
      <td>0.000071</td>
      <td>1.420938</td>
      <td>2.830658e-13</td>
      <td>152.000000</td>
      <td>1.184189e-12</td>
      <td>0.185986</td>
      <td>1.302697</td>
      <td>40.662797</td>
      <td>38.201188</td>
      <td>21.136015</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>498231</th>
      <td>0.213285</td>
      <td>0.466663</td>
      <td>0.000059</td>
      <td>1.416784</td>
      <td>3.782943e-13</td>
      <td>107.000000</td>
      <td>7.331979e-13</td>
      <td>0.403218</td>
      <td>1.197010</td>
      <td>32.639846</td>
      <td>41.078960</td>
      <td>26.281194</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509477</th>
      <td>0.175133</td>
      <td>0.567740</td>
      <td>0.000103</td>
      <td>1.383180</td>
      <td>2.438575e-12</td>
      <td>152.000000</td>
      <td>3.039095e-12</td>
      <td>0.428779</td>
      <td>0.807465</td>
      <td>62.072368</td>
      <td>17.973684</td>
      <td>19.953947</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509479</th>
      <td>0.230885</td>
      <td>0.378365</td>
      <td>0.000079</td>
      <td>1.374540</td>
      <td>1.031721e-13</td>
      <td>125.000000</td>
      <td>3.172415e-12</td>
      <td>NaN</td>
      <td>1.524444</td>
      <td>39.279352</td>
      <td>38.916498</td>
      <td>21.804150</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509481</th>
      <td>0.230885</td>
      <td>0.378365</td>
      <td>0.000079</td>
      <td>1.374540</td>
      <td>1.031721e-13</td>
      <td>125.000000</td>
      <td>3.172415e-12</td>
      <td>NaN</td>
      <td>1.524444</td>
      <td>39.279352</td>
      <td>38.916498</td>
      <td>21.804150</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509482</th>
      <td>0.207877</td>
      <td>0.369886</td>
      <td>0.000092</td>
      <td>1.397760</td>
      <td>1.474479e-13</td>
      <td>120.500000</td>
      <td>4.654687e-12</td>
      <td>NaN</td>
      <td>1.530585</td>
      <td>45.389069</td>
      <td>37.890283</td>
      <td>16.720648</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509513</th>
      <td>0.219597</td>
      <td>0.445168</td>
      <td>0.000072</td>
      <td>1.395746</td>
      <td>2.727324e-13</td>
      <td>152.000000</td>
      <td>9.122162e-13</td>
      <td>0.237423</td>
      <td>1.280039</td>
      <td>38.422252</td>
      <td>35.742028</td>
      <td>25.835720</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509514</th>
      <td>0.241801</td>
      <td>0.474101</td>
      <td>0.000079</td>
      <td>1.340429</td>
      <td>2.435161e-13</td>
      <td>152.000000</td>
      <td>2.375523e-13</td>
      <td>0.271630</td>
      <td>1.274496</td>
      <td>30.592982</td>
      <td>31.535307</td>
      <td>37.871711</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509529</th>
      <td>0.196811</td>
      <td>0.356163</td>
      <td>0.000157</td>
      <td>1.406091</td>
      <td>2.260935e-13</td>
      <td>152.000000</td>
      <td>5.850942e-12</td>
      <td>NaN</td>
      <td>1.607097</td>
      <td>63.571711</td>
      <td>22.369079</td>
      <td>14.059211</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509532</th>
      <td>0.199783</td>
      <td>0.412306</td>
      <td>0.000087</td>
      <td>1.422578</td>
      <td>2.966015e-13</td>
      <td>152.000000</td>
      <td>1.526682e-12</td>
      <td>0.182238</td>
      <td>1.356006</td>
      <td>47.934946</td>
      <td>34.134907</td>
      <td>17.930147</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509544</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>152.000000</td>
      <td>7.000000e-15</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509547</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>152.000000</td>
      <td>4.230700e-11</td>
      <td>NaN</td>
      <td>2.030000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509548</th>
      <td>0.189314</td>
      <td>0.404765</td>
      <td>0.000104</td>
      <td>1.433685</td>
      <td>3.617371e-13</td>
      <td>152.000000</td>
      <td>2.006536e-12</td>
      <td>0.193350</td>
      <td>1.379123</td>
      <td>53.676535</td>
      <td>31.072368</td>
      <td>15.251096</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509559</th>
      <td>0.210870</td>
      <td>0.420608</td>
      <td>0.000078</td>
      <td>1.410010</td>
      <td>2.516507e-13</td>
      <td>61.812500</td>
      <td>7.504374e-13</td>
      <td>0.151250</td>
      <td>1.341513</td>
      <td>43.240132</td>
      <td>35.652961</td>
      <td>21.106908</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509561</th>
      <td>0.246665</td>
      <td>0.467696</td>
      <td>0.000081</td>
      <td>1.332817</td>
      <td>2.088819e-13</td>
      <td>139.647059</td>
      <td>1.590777e-13</td>
      <td>0.218625</td>
      <td>1.305591</td>
      <td>30.228443</td>
      <td>31.026630</td>
      <td>38.744927</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509577</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>152.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509733</th>
      <td>0.157366</td>
      <td>0.400499</td>
      <td>0.000221</td>
      <td>1.762072</td>
      <td>1.819618e-12</td>
      <td>86.000000</td>
      <td>5.262229e-12</td>
      <td>0.449752</td>
      <td>1.423158</td>
      <td>82.200000</td>
      <td>9.300000</td>
      <td>8.500000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>509794</th>
      <td>0.220962</td>
      <td>0.383130</td>
      <td>0.000140</td>
      <td>1.367408</td>
      <td>2.004353e-13</td>
      <td>152.000000</td>
      <td>1.554090e-12</td>
      <td>0.415245</td>
      <td>1.545395</td>
      <td>60.571711</td>
      <td>18.441447</td>
      <td>20.986842</td>
      <td>NRCS</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To demonstrate what we mean by this, plot the porosity of the soil column.</span>
<span class="n">porosity_nrcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">porosity_rosetta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">porosity_nrcs</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mukey</span><span class="p">,</span> <span class="s1">&#39;porosity [-]&#39;</span><span class="p">]</span>
    <span class="n">porosity_rosetta</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mukey</span><span class="p">,</span> <span class="s1">&#39;Rosetta porosity [-]&#39;</span><span class="p">]</span>

<span class="n">pmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">porosity_nrcs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">porosity_rosetta</span><span class="p">))</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">porosity_nrcs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">porosity_rosetta</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min, max = &#39;</span><span class="p">,</span> <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="n">porosity_nrcs</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> 
                                           <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;porosity (NRCS) [-]&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


<span class="n">ax2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">porosity_rosetta</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;porosity (Rosetta) [-]&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>min, max =  0.15125 0.567739729619314
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/9579ed42c68f1671aa72224b81f7b2b5f31e1111386b252e1c4f15de078cb6d0.png" src="../_images/9579ed42c68f1671aa72224b81f7b2b5f31e1111386b252e1c4f15de078cb6d0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># averaging permeability is a tricky beast.  we average in log space, check that </span>
<span class="c1"># unit conversions make sense</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">soil_perm_nrcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">soil_perm_rosetta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">soil_perm_nrcs</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mukey</span><span class="p">,</span> <span class="s1">&#39;permeability [m^2]&#39;</span><span class="p">]</span>
    <span class="n">soil_perm_rosetta</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mukey</span><span class="p">,</span> <span class="s1">&#39;Rosetta permeability [m^2]&#39;</span><span class="p">]</span>

<span class="n">pmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_nrcs</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_rosetta</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_nrcs</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_rosetta</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

  
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;min = </span><span class="si">{</span><span class="n">pmin</span><span class="si">}</span><span class="s1">, max = </span><span class="si">{</span><span class="n">pmax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_nrcs</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log permeability (NRCS) [m^2]&#39;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_rosetta</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log permeability (Rosetta) [m^2]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2458/45597466.py:11: RuntimeWarning: All-NaN axis encountered
  pmin = min(np.nanmin(np.log10(soil_perm_nrcs)), np.nanmin(np.log10(soil_perm_rosetta).min()))
/tmp/ipykernel_2458/45597466.py:12: RuntimeWarning: All-NaN axis encountered
  pmax = max(np.nanmax(np.log10(soil_perm_nrcs)), np.nanmax(np.log10(soil_perm_rosetta).max()))
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>min = -14.154901959985743, max = -10.373587769507715
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;log permeability (Rosetta) [m^2]&#39;)
</pre></div>
</div>
<img alt="../_images/888d4e3dd564c15ca6c9ee6359b338d76aa46bea1e2f250e10ccfc9550d0eae0.png" src="../_images/888d4e3dd564c15ca6c9ee6359b338d76aa46bea1e2f250e10ccfc9550d0eae0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># finally, let&#39;s look at the soil thickness, which will define the depth of this layer</span>
<span class="n">soil_thickness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">soil_thickness</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mukey</span><span class="p">,</span> <span class="s1">&#39;thickness [cm]&#39;</span><span class="p">]</span>

<span class="c1"># print(soil_thickness)</span>
<span class="n">soil_thickness</span> <span class="o">=</span> <span class="n">soil_thickness</span> <span class="o">/</span> <span class="mi">100</span> <span class="c1"># convert cm to m</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">soil_thickness</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;soil thickness [m]&#39;</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Median soil thickness = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">soil_thickness</span><span class="p">)</span><span class="si">}</span><span class="s1"> [m]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Median soil thickness = 1.52 [m]
</pre></div>
</div>
<img alt="../_images/b9c5d73e2de3b4ee7cb175176466e46a59a0c6235eaf09e666ea59be7ba35828.png" src="../_images/b9c5d73e2de3b4ee7cb175176466e46a59a0c6235eaf09e666ea59be7ba35828.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reindex_remove_duplicates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes duplicates, creating a new index and saving the old index as tuples of duplicate values. In place!&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># identify duplicate rows, use all cols as duplicate target</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>

    <span class="c1"># order is preserved</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">duplicates</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">replace_column_nans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_nan</span><span class="p">,</span> <span class="n">col_replacement</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In a df, replace col_nan entries by col_replacement if is nan.  In Place!&quot;&quot;&quot;</span>
    <span class="n">row_indexer</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_nan</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">,</span> <span class="n">col_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_indexer</span><span class="p">,</span> <span class="n">col_replacement</span><span class="p">]</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note the missing data (white).  This is because some SSURGO map units have no formation with complete </span>
<span class="c1"># information.  So we merge the above available data, filling where possible and dropping regions that</span>
<span class="c1"># do not have a complete set of properties.</span>
<span class="c1"># soil_survey_props_clean = soil_survey_props.copy()</span>
<span class="n">soil_survey_props_clean</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># later scripts expect &#39;native_index&#39; as a standard name of holding onto the original IDs</span>
<span class="c1"># soil_survey_props_clean.rename_axis(&#39;native_index&#39;, inplace=True)</span>
<span class="n">soil_survey_props_clean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mukey&#39;</span><span class="p">:</span><span class="s1">&#39;native_index&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># need thickness in m</span>
<span class="n">soil_survey_props_clean</span><span class="p">[</span><span class="s1">&#39;thickness [cm]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props_clean</span><span class="p">[</span><span class="s1">&#39;thickness [cm]&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span>
<span class="n">soil_survey_props_clean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;thickness [cm]&#39;</span><span class="p">:</span><span class="s1">&#39;thickness [m]&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># where poro or perm is nan, put Rosetta poro</span>
<span class="n">replace_column_nans</span><span class="p">(</span><span class="n">soil_survey_props_clean</span><span class="p">,</span> <span class="s1">&#39;porosity [-]&#39;</span><span class="p">,</span> <span class="s1">&#39;Rosetta porosity [-]&#39;</span><span class="p">)</span>
<span class="n">replace_column_nans</span><span class="p">(</span><span class="n">soil_survey_props_clean</span><span class="p">,</span> <span class="s1">&#39;permeability [m^2]&#39;</span><span class="p">,</span> <span class="s1">&#39;Rosetta permeability [m^2]&#39;</span><span class="p">)</span>

<span class="c1"># drop unnecessary columns</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Rosetta porosity [-]&#39;</span><span class="p">,</span> <span class="s1">&#39;Rosetta permeability [m^2]&#39;</span><span class="p">,</span> <span class="s1">&#39;bulk density [g/cm^3]&#39;</span><span class="p">,</span> <span class="s1">&#39;total sand pct [%]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;total silt pct [%]&#39;</span><span class="p">,</span> <span class="s1">&#39;total clay pct [%]&#39;</span><span class="p">]:</span>
    <span class="n">soil_survey_props_clean</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<span class="n">soil_survey_props_clean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>native_index</th>
      <th>residual saturation [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>thickness [m]</th>
      <th>permeability [m^2]</th>
      <th>porosity [-]</th>
      <th>source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>498185</td>
      <td>0.240269</td>
      <td>0.000092</td>
      <td>1.319916</td>
      <td>1.520000</td>
      <td>2.279759e-13</td>
      <td>0.265563</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>1</th>
      <td>498205</td>
      <td>0.181598</td>
      <td>0.000139</td>
      <td>1.457559</td>
      <td>1.520000</td>
      <td>2.734080e-12</td>
      <td>0.159737</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>2</th>
      <td>498206</td>
      <td>0.181598</td>
      <td>0.000139</td>
      <td>1.457559</td>
      <td>1.520000</td>
      <td>2.734080e-12</td>
      <td>0.159737</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>3</th>
      <td>498208</td>
      <td>0.208316</td>
      <td>0.000071</td>
      <td>1.420938</td>
      <td>1.520000</td>
      <td>1.184189e-12</td>
      <td>0.185986</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>4</th>
      <td>498231</td>
      <td>0.213285</td>
      <td>0.000059</td>
      <td>1.416784</td>
      <td>1.070000</td>
      <td>7.331979e-13</td>
      <td>0.403218</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>5</th>
      <td>509477</td>
      <td>0.175133</td>
      <td>0.000103</td>
      <td>1.383180</td>
      <td>1.520000</td>
      <td>3.039095e-12</td>
      <td>0.428779</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>6</th>
      <td>509479</td>
      <td>0.230885</td>
      <td>0.000079</td>
      <td>1.374540</td>
      <td>1.250000</td>
      <td>3.172415e-12</td>
      <td>0.378365</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>7</th>
      <td>509481</td>
      <td>0.230885</td>
      <td>0.000079</td>
      <td>1.374540</td>
      <td>1.250000</td>
      <td>3.172415e-12</td>
      <td>0.378365</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>8</th>
      <td>509482</td>
      <td>0.207877</td>
      <td>0.000092</td>
      <td>1.397760</td>
      <td>1.205000</td>
      <td>4.654687e-12</td>
      <td>0.369886</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>9</th>
      <td>509513</td>
      <td>0.219597</td>
      <td>0.000072</td>
      <td>1.395746</td>
      <td>1.520000</td>
      <td>9.122162e-13</td>
      <td>0.237423</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>10</th>
      <td>509514</td>
      <td>0.241801</td>
      <td>0.000079</td>
      <td>1.340429</td>
      <td>1.520000</td>
      <td>2.375523e-13</td>
      <td>0.271630</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>11</th>
      <td>509529</td>
      <td>0.196811</td>
      <td>0.000157</td>
      <td>1.406091</td>
      <td>1.520000</td>
      <td>5.850942e-12</td>
      <td>0.356163</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>12</th>
      <td>509532</td>
      <td>0.199783</td>
      <td>0.000087</td>
      <td>1.422578</td>
      <td>1.520000</td>
      <td>1.526682e-12</td>
      <td>0.182238</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>13</th>
      <td>509544</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.520000</td>
      <td>7.000000e-15</td>
      <td>NaN</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>14</th>
      <td>509547</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.520000</td>
      <td>4.230700e-11</td>
      <td>NaN</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>15</th>
      <td>509548</td>
      <td>0.189314</td>
      <td>0.000104</td>
      <td>1.433685</td>
      <td>1.520000</td>
      <td>2.006536e-12</td>
      <td>0.193350</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>16</th>
      <td>509559</td>
      <td>0.210870</td>
      <td>0.000078</td>
      <td>1.410010</td>
      <td>0.618125</td>
      <td>7.504374e-13</td>
      <td>0.151250</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>17</th>
      <td>509561</td>
      <td>0.246665</td>
      <td>0.000081</td>
      <td>1.332817</td>
      <td>1.396471</td>
      <td>1.590777e-13</td>
      <td>0.218625</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>18</th>
      <td>509577</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.520000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>19</th>
      <td>509733</td>
      <td>0.157366</td>
      <td>0.000221</td>
      <td>1.762072</td>
      <td>0.860000</td>
      <td>5.262229e-12</td>
      <td>0.449752</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>20</th>
      <td>509794</td>
      <td>0.220962</td>
      <td>0.000140</td>
      <td>1.367408</td>
      <td>1.520000</td>
      <td>1.554090e-12</td>
      <td>0.415245</td>
      <td>NRCS</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># drop nans</span>
<span class="c1"># soil id with missing properties will be removed, and the space will be filled by geology from below (see mesh extrusion)!</span>
<span class="n">soil_survey_props_clean</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">soil_survey_props_clean</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># remove duplicates</span>
<span class="n">reindex_remove_duplicates</span><span class="p">(</span><span class="n">soil_survey_props_clean</span><span class="p">,</span> <span class="s1">&#39;native_index&#39;</span><span class="p">)</span>

<span class="c1"># assert soil_survey_props_clean[&#39;porosity [-]&#39;][:].min() &gt;= min_porosity</span>
<span class="c1"># assert soil_survey_props_clean[&#39;permeability [m^2]&#39;][:].max() &lt;= max_permeability</span>
<span class="n">soil_survey_props_clean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>native_index</th>
      <th>residual saturation [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>thickness [m]</th>
      <th>permeability [m^2]</th>
      <th>porosity [-]</th>
      <th>source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(509733,)</td>
      <td>0.240269</td>
      <td>0.000092</td>
      <td>1.319916</td>
      <td>1.520000</td>
      <td>2.279759e-13</td>
      <td>0.265563</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(509477,)</td>
      <td>0.181598</td>
      <td>0.000139</td>
      <td>1.457559</td>
      <td>1.520000</td>
      <td>2.734080e-12</td>
      <td>0.159737</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(498205, 498206)</td>
      <td>0.208316</td>
      <td>0.000071</td>
      <td>1.420938</td>
      <td>1.520000</td>
      <td>1.184189e-12</td>
      <td>0.185986</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(509548,)</td>
      <td>0.213285</td>
      <td>0.000059</td>
      <td>1.416784</td>
      <td>1.070000</td>
      <td>7.331979e-13</td>
      <td>0.403218</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(509529,)</td>
      <td>0.175133</td>
      <td>0.000103</td>
      <td>1.383180</td>
      <td>1.520000</td>
      <td>3.039095e-12</td>
      <td>0.428779</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>5</th>
      <td>(509532,)</td>
      <td>0.230885</td>
      <td>0.000079</td>
      <td>1.374540</td>
      <td>1.250000</td>
      <td>3.172415e-12</td>
      <td>0.378365</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>6</th>
      <td>(509482,)</td>
      <td>0.207877</td>
      <td>0.000092</td>
      <td>1.397760</td>
      <td>1.205000</td>
      <td>4.654687e-12</td>
      <td>0.369886</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>7</th>
      <td>(498208,)</td>
      <td>0.219597</td>
      <td>0.000072</td>
      <td>1.395746</td>
      <td>1.520000</td>
      <td>9.122162e-13</td>
      <td>0.237423</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>8</th>
      <td>(509559,)</td>
      <td>0.241801</td>
      <td>0.000079</td>
      <td>1.340429</td>
      <td>1.520000</td>
      <td>2.375523e-13</td>
      <td>0.271630</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(498231,)</td>
      <td>0.196811</td>
      <td>0.000157</td>
      <td>1.406091</td>
      <td>1.520000</td>
      <td>5.850942e-12</td>
      <td>0.356163</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>10</th>
      <td>(509513,)</td>
      <td>0.199783</td>
      <td>0.000087</td>
      <td>1.422578</td>
      <td>1.520000</td>
      <td>1.526682e-12</td>
      <td>0.182238</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>11</th>
      <td>(509794,)</td>
      <td>0.189314</td>
      <td>0.000104</td>
      <td>1.433685</td>
      <td>1.520000</td>
      <td>2.006536e-12</td>
      <td>0.193350</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>12</th>
      <td>(509479, 509481)</td>
      <td>0.210870</td>
      <td>0.000078</td>
      <td>1.410010</td>
      <td>0.618125</td>
      <td>7.504374e-13</td>
      <td>0.151250</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>13</th>
      <td>(498185,)</td>
      <td>0.246665</td>
      <td>0.000081</td>
      <td>1.332817</td>
      <td>1.396471</td>
      <td>1.590777e-13</td>
      <td>0.218625</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>14</th>
      <td>(509514,)</td>
      <td>0.157366</td>
      <td>0.000221</td>
      <td>1.762072</td>
      <td>0.860000</td>
      <td>5.262229e-12</td>
      <td>0.449752</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>15</th>
      <td>(509561,)</td>
      <td>0.220962</td>
      <td>0.000140</td>
      <td>1.367408</td>
      <td>1.520000</td>
      <td>1.554090e-12</td>
      <td>0.415245</td>
      <td>NRCS</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a new soil_color, keeping on those that are kept here and re-indexing to ATS indices</span>
<span class="n">soil_color_new</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">soil_color</span><span class="p">)</span>
<span class="k">for</span> <span class="n">new_id</span><span class="p">,</span> <span class="n">mukeys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">soil_survey_props_clean</span><span class="p">[</span><span class="s1">&#39;native_index&#39;</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">mukeys</span><span class="p">:</span>
        <span class="n">soil_color_new</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">+</span><span class="n">new_id</span>

<span class="c1"># # make sure no -1 in soil ids</span>
<span class="c1"># assert -1 not in np.unique(soil_color_new)</span>
        
<span class="c1"># image the new soil_color</span>
<span class="n">indices</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_indexed_colormap</span><span class="p">(</span><span class="n">soil_color_new</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">soil_color_new</span><span class="p">,</span> 
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">soil_color_new</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;soil type index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;linewidth&#39;: 0, &#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x409c79b4c0&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x409c79b9d0&gt;}
setting face color =  [1000 1011 1005 ... 1012   -1 1012]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/5beb387b9d9e2f7fa3f5d32f088815029e05bb268706b65b5a5aec9e9d6950f7.png" src="../_images/5beb387b9d9e2f7fa3f5d32f088815029e05bb268706b65b5a5aec9e9d6950f7.png" />
</div>
</div>
</section>
<section id="glhymps-geologic-layer">
<h3>GLHYMPS geologic layer<a class="headerlink" href="#glhymps-geologic-layer" title="Permalink to this heading">#</a></h3>
<p>A copy of GLHYMPS v2 geologic shapefile has to be manually downloaded before running the following scripts (see source section for download instructions).</p>
<p>This will get properties (i.e., permeability and porosity) for each geologic layer. In case of missing data, default values of permeability (inf?) and porosity (0.01) will be used. Default van Genuchten alpha, n, and residual saturation are used due to lack of soil/silt/clay pct information. <span style="color:blue;"> </span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the GLYHMPS geologic structure data as shapes and project it onto the mesh</span>
<span class="n">target_bounds</span> <span class="o">=</span> <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;target bounds: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_bounds</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">geo_survey</span><span class="p">,</span> <span class="n">geo_survey_props</span> <span class="o">=</span> \
    <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;geologic structure&#39;</span><span class="p">],</span> <span class="n">target_bounds</span><span class="p">,</span> 
                                  <span class="n">crs</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># -- log the bounds targetted and found</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;shape union bounds: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">shapely</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">cascaded_union</span><span class="p">(</span><span class="n">geo_survey</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span><span class="p">))</span>

<span class="c1"># -- determine the ID for each soil unit; this uniquely identifies formation</span>
<span class="c1">#    properties</span>
<span class="n">geo_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shp</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">shp</span> <span class="ow">in</span> <span class="n">geo_survey</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># -- color a raster by the polygons (this makes identifying a triangle&#39;s value much </span>
<span class="c1">#    more efficient)</span>
<span class="n">geo_color_profile</span><span class="p">,</span> <span class="n">geo_color_raster</span> <span class="o">=</span> \
            <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">color_raster_from_shapes</span><span class="p">(</span><span class="n">geo_survey</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">geo_ids</span><span class="p">,</span>
                                                        <span class="n">target_bounds</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># -- resample the raster to the triangles</span>
<span class="n">geo_color</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> 
                                         <span class="n">geo_color_raster</span><span class="p">,</span> <span class="n">geo_color_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:13:38,410 - root - INFO: target bounds: (317251.2640131897, 4299711.408984916, 328473.4449929282, 4307052.970983125)
2023-07-19 19:13:38,414 - root - INFO: 
2023-07-19 19:13:38,417 - root - INFO: Loading shapes
2023-07-19 19:13:38,420 - root - INFO: ------------------------------
2023-07-19 19:13:38,424 - root - INFO: Getting shapes of GLHYMPS on bounds: (317251.2640131897, 4299711.408984916, 328473.4449929282, 4307052.970983125)
2023-07-19 19:13:38,722 - root - INFO: ... found 17 shapes
2023-07-19 19:13:38,724 - root - INFO: Converting to shapely
2023-07-19 19:13:38,786 - root - INFO: Converting to requested CRS
2023-07-19 19:13:38,982 - root - INFO: shape union bounds: (309452.03384970897, 4277422.824854818, 338890.05886956863, 4329709.205645651)
2023-07-19 19:13:38,986 - root - INFO: Coloring shapes onto raster:
2023-07-19 19:13:38,995 - root - INFO:   of shape: (735, 1124)
2023-07-19 19:13:38,998 - root - INFO:   and 17 independent colors
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geo_color</span> <span class="o">=</span> <span class="n">geo_color</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">geo_survey_props</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">geo_survey_props</span> <span class="o">=</span> <span class="n">geo_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">geo_color</span><span class="p">),</span> <span class="p">:]</span>
<span class="n">geo_survey_props</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>source</th>
      <th>permeability [m^2]</th>
      <th>logk_stdev [-]</th>
      <th>porosity [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>residual saturation [-]</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>715639</th>
      <td>GLHYMPS</td>
      <td>6.309573e-16</td>
      <td>2.50</td>
      <td>0.19</td>
      <td>0.000025</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>715707</th>
      <td>GLHYMPS</td>
      <td>1.000000e-13</td>
      <td>2.00</td>
      <td>0.22</td>
      <td>0.000294</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>715766</th>
      <td>GLHYMPS</td>
      <td>3.162278e-13</td>
      <td>1.80</td>
      <td>0.09</td>
      <td>0.000817</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>715779</th>
      <td>GLHYMPS</td>
      <td>1.000000e-13</td>
      <td>2.00</td>
      <td>0.22</td>
      <td>0.000294</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>715796</th>
      <td>GLHYMPS</td>
      <td>6.309573e-16</td>
      <td>2.50</td>
      <td>0.19</td>
      <td>0.000025</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>726604</th>
      <td>GLHYMPS</td>
      <td>6.309573e-16</td>
      <td>2.50</td>
      <td>0.19</td>
      <td>0.000025</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>726608</th>
      <td>GLHYMPS</td>
      <td>6.309573e-16</td>
      <td>2.50</td>
      <td>0.19</td>
      <td>0.000025</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>726639</th>
      <td>GLHYMPS</td>
      <td>3.162278e-13</td>
      <td>1.80</td>
      <td>0.09</td>
      <td>0.000817</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>726642</th>
      <td>GLHYMPS</td>
      <td>1.000000e-13</td>
      <td>2.00</td>
      <td>0.22</td>
      <td>0.000294</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>726664</th>
      <td>GLHYMPS</td>
      <td>1.000000e-13</td>
      <td>2.00</td>
      <td>0.22</td>
      <td>0.000294</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>726667</th>
      <td>GLHYMPS</td>
      <td>3.162278e-13</td>
      <td>1.80</td>
      <td>0.09</td>
      <td>0.000817</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>730801</th>
      <td>GLHYMPS</td>
      <td>3.019952e-11</td>
      <td>1.61</td>
      <td>0.01</td>
      <td>0.023953</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the geologic formation id</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">indices</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_indexed_colormap</span><span class="p">(</span><span class="n">geo_color</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>


<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">geo_color</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">geo_color</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;geology type index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;linewidth&#39;: 0, &#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x409c99a7a0&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x409c99a770&gt;}
setting face color =  [730801 730801 726639 ... 726639 726639 726639]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/60ab8685761ad43ea324d2f3044b419c24c64f5e580adc6a31c2500a070d97e9.png" src="../_images/60ab8685761ad43ea324d2f3044b419c24c64f5e580adc6a31c2500a070d97e9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># averaging permeability is a tricky beast.  we average in log space, check that unit conversions make sense</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">geol_perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">geo_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="c1"># soil_perm_rosetta = np.empty(soil_color.shape, &#39;d&#39;)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geo_survey_props</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">geol_perm</span><span class="p">[</span><span class="n">geo_color</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;permeability [m^2]&#39;</span><span class="p">]</span>
<span class="c1">#     soil_perm_rosetta[soil_color == mukey] = soil_survey_props.loc[soil_survey_props[&#39;mukey&#39;] == mukey, &#39;Rosetta permeability [m^2]&#39;]</span>

<span class="n">pmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">geol_perm</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">geol_perm</span><span class="p">)))</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">geol_perm</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">geol_perm</span><span class="p">)))</span>

  
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;min = </span><span class="si">{</span><span class="n">pmin</span><span class="si">}</span><span class="s1">, max = </span><span class="si">{</span><span class="n">pmax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">geol_perm</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;geology log permeability [m^2]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>min = -15.2, max = -10.52
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 1800x900 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/4b3de61eba150f2df6813927fb162eba2fda94ecd925f077910fe75e6fd8956d.png" src="../_images/4b3de61eba150f2df6813927fb162eba2fda94ecd925f077910fe75e6fd8956d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># note there are clearly some common regions -- no need to duplicate those with identical values.</span>
<span class="n">geo_survey_props</span> <span class="o">=</span> <span class="n">geo_survey_props</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">geo_survey_props_clean</span> <span class="o">=</span> <span class="n">geo_survey_props</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">geo_survey_props_clean</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logk_stdev [-]&#39;</span><span class="p">)</span>
<span class="n">geo_survey_props_clean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;native_index&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># remove duplicates</span>
<span class="n">reindex_remove_duplicates</span><span class="p">(</span><span class="n">geo_survey_props_clean</span><span class="p">,</span> <span class="s1">&#39;native_index&#39;</span><span class="p">)</span>
<span class="c1"># assert geo_survey_props_clean[&#39;porosity [-]&#39;][:].min() &gt;= min_porosity</span>
<span class="c1"># assert geo_survey_props_clean[&#39;permeability [m^2]&#39;][:].max() &lt;= max_permeability</span>
<span class="c1"># assert geo_survey_props_clean[&#39;van Genuchten alpha [Pa^-1]&#39;][:].max() &lt;= max_vg_alpha</span>

<span class="n">geo_survey_props_clean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>native_index</th>
      <th>source</th>
      <th>permeability [m^2]</th>
      <th>porosity [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>residual saturation [-]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(715639, 715796, 726604, 726608)</td>
      <td>GLHYMPS</td>
      <td>6.309573e-16</td>
      <td>0.19</td>
      <td>0.000025</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(715707, 715779, 726642, 726664)</td>
      <td>GLHYMPS</td>
      <td>1.000000e-13</td>
      <td>0.22</td>
      <td>0.000294</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(715766, 726639, 726667)</td>
      <td>GLHYMPS</td>
      <td>3.162278e-13</td>
      <td>0.09</td>
      <td>0.000817</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(730801,)</td>
      <td>GLHYMPS</td>
      <td>3.019952e-11</td>
      <td>0.01</td>
      <td>0.023953</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a new geologic layer color, keeping on those that are kept here and re-indexing to ATS indices</span>
<span class="n">geo_color_new</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">geo_color</span><span class="p">)</span>
<span class="k">for</span> <span class="n">new_id</span><span class="p">,</span> <span class="n">old_id_dups</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geo_survey_props_clean</span><span class="p">[</span><span class="s1">&#39;native_index&#39;</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">old_id</span> <span class="ow">in</span> <span class="n">old_id_dups</span><span class="p">:</span>
        <span class="n">geo_color_new</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">geo_color</span> <span class="o">==</span> <span class="n">old_id</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">+</span> <span class="n">new_id</span>
    
<span class="c1"># image the new geo_color</span>
<span class="n">indices</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_indexed_colormap</span><span class="p">(</span><span class="n">geo_color_new</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">geo_color_new</span><span class="p">,</span> 
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">geo_color_new</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;geologic type index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/envs/watershed_workflow/lib/python3.10/site-packages/pyproj/crs/crs.py:1282: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  proj = self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kwargs =  {&#39;linewidth&#39;: 0, &#39;cmap&#39;: &lt;matplotlib.colors.ListedColormap object at 0x4095fc4430&gt;, &#39;norm&#39;: &lt;matplotlib.colors.BoundaryNorm object at 0x4095fc70d0&gt;}
setting face color =  [103 103 102 ... 102 102 102]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/8cbc053f7308da15aff01be9840c08af96ea19642989187d556d7cd762d8efe0.png" src="../_images/8cbc053f7308da15aff01be9840c08af96ea19642989187d556d7cd762d8efe0.png" />
</div>
</div>
</section>
</section>
<section id="depth-to-bedrock">
<h2>Depth-to-bedrock<a class="headerlink" href="#depth-to-bedrock" title="Permalink to this heading">#</a></h2>
<p>Depth to bedrock is taken from the <a class="reference external" href="http://globalchange.bnu.edu.cn/research/dtb.jsp">SoilGrids</a> product.  Here we download a US-based, clipped version of this global product, as file sizes are quite large (all products potentially used total over 100GB).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DTB_profile</span><span class="p">,</span> <span class="n">DTB_raster</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_raster_on_shape</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;depth to bedrock&#39;</span><span class="p">],</span> 
                                                                 <span class="n">watershed</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> 
                                                                 <span class="n">nodata</span><span class="o">=-</span><span class="mi">99999</span><span class="p">)</span>
                                        <span class="c1">#, variable=&#39;BDTICM&#39;) # note, this argument needed for </span>
                                        <span class="c1"># using the default SoilGrids dataset.</span>

<span class="c1"># resample the raster to the triangles</span>
<span class="n">DTB_raster</span> <span class="o">=</span> <span class="n">DTB_raster</span><span class="o">/</span><span class="mi">100</span> <span class="c1">#convert from cm to m</span>
<span class="n">DTB</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">DTB_raster</span><span class="p">,</span> <span class="n">DTB_profile</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;piecewise bilinear&#39;</span><span class="p">)</span>
<span class="n">DTB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DTB</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DTB</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:13:58,619 - root - INFO: 
2023-07-19 19:13:58,623 - root - INFO: Loading Raster
2023-07-19 19:13:58,626 - root - INFO: ------------------------------
2023-07-19 19:13:58,638 - root - INFO: Collecting raster
2023-07-19 19:13:58,717 - root - INFO: bounds in my_crs: (-107.10634327399998, 38.82770288200003, -106.97736783099998, 38.89466788700003)
2023-07-19 19:13:58,724 - root - INFO: ... got raster of shape: (33, 63)
2023-07-19 19:13:58,736 - root - INFO: ... got raster bounds: (-107.10834499599999, 38.895007756000005, -106.97709501699998, 38.82625776700001)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the resulting surface mesh</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">DTB</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma_r&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;DTB [m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(316690.15495, 329034.55405000004, 4299344.3309, 4307420.0490999995)
</pre></div>
</div>
<img alt="../_images/08590e1b9c5ee47ccd87513cf19593efc99330832b775462afba4ef590a4be68.png" src="../_images/08590e1b9c5ee47ccd87513cf19593efc99330832b775462afba4ef590a4be68.png" />
</div>
</div>
</section>
<section id="mesh-extrusion">
<h2>Mesh extrusion<a class="headerlink" href="#mesh-extrusion" title="Permalink to this heading">#</a></h2>
<p>Given the surface mesh and material IDs on both the surface and subsurface, we can extrude the surface mesh in the vertical to make a 3D mesh.</p>
<p>First, all integer IDs in Exodus files must be unique.  This includes Material IDs, side sets, etc.  We create the Material ID map and data frame.  This is used to standardize IDs from multiple data sources.  Traditionally, ATS numbers Material IDs/Side Sets as:</p>
<ul class="simple">
<li><p>0-9 : reserved for boundaries, surface/bottom, etc</p></li>
<li><p>10-99 : Land Cover side sets, typically NLCD IDs are used</p></li>
<li><p>100-999 : geologic layer material IDs</p></li>
<li><p>1000-9999 : soil layer material IDs</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># map SSURGO mukey to ATS_ID</span>
<span class="n">soil_survey_props_clean</span><span class="p">[</span><span class="s1">&#39;ats_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">soil_survey_props_clean</span><span class="p">))</span>
<span class="n">soil_survey_props_clean</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ats_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># map GLHYMPS id to ATS_ID</span>
<span class="n">geo_survey_props_clean</span><span class="p">[</span><span class="s1">&#39;ats_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">geo_survey_props_clean</span><span class="p">))</span>
<span class="n">geo_survey_props_clean</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ats_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bedrock_props</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">soil_properties</span><span class="o">.</span><span class="n">get_bedrock_properties</span><span class="p">()</span>
<span class="n">bedrock_props</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SoilGrids&#39;</span>
<span class="n">bedrock_props</span><span class="p">[</span><span class="s1">&#39;native_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(999,)&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># merge the properties databases</span>
<span class="n">subsurface_props</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">geo_survey_props_clean</span><span class="p">,</span>
                                  <span class="n">soil_survey_props_clean</span><span class="p">,</span>
                                  <span class="n">bedrock_props</span><span class="p">])</span>
<span class="n">subsurface_props</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>native_index</th>
      <th>source</th>
      <th>permeability [m^2]</th>
      <th>porosity [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>residual saturation [-]</th>
      <th>thickness [m]</th>
    </tr>
    <tr>
      <th>ats_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>100</th>
      <td>(715639, 715796, 726604, 726608)</td>
      <td>GLHYMPS</td>
      <td>6.309573e-16</td>
      <td>0.190000</td>
      <td>0.000025</td>
      <td>2.000000</td>
      <td>0.010000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>101</th>
      <td>(715707, 715779, 726642, 726664)</td>
      <td>GLHYMPS</td>
      <td>1.000000e-13</td>
      <td>0.220000</td>
      <td>0.000294</td>
      <td>2.000000</td>
      <td>0.010000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>102</th>
      <td>(715766, 726639, 726667)</td>
      <td>GLHYMPS</td>
      <td>3.162278e-13</td>
      <td>0.090000</td>
      <td>0.000817</td>
      <td>2.000000</td>
      <td>0.010000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>103</th>
      <td>(730801,)</td>
      <td>GLHYMPS</td>
      <td>3.019952e-11</td>
      <td>0.010000</td>
      <td>0.023953</td>
      <td>2.000000</td>
      <td>0.010000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1000</th>
      <td>(509733,)</td>
      <td>NRCS</td>
      <td>2.279759e-13</td>
      <td>0.265563</td>
      <td>0.000092</td>
      <td>1.319916</td>
      <td>0.240269</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1001</th>
      <td>(509477,)</td>
      <td>NRCS</td>
      <td>2.734080e-12</td>
      <td>0.159737</td>
      <td>0.000139</td>
      <td>1.457559</td>
      <td>0.181598</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1002</th>
      <td>(498205, 498206)</td>
      <td>NRCS</td>
      <td>1.184189e-12</td>
      <td>0.185986</td>
      <td>0.000071</td>
      <td>1.420938</td>
      <td>0.208316</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1003</th>
      <td>(509548,)</td>
      <td>NRCS</td>
      <td>7.331979e-13</td>
      <td>0.403218</td>
      <td>0.000059</td>
      <td>1.416784</td>
      <td>0.213285</td>
      <td>1.070000</td>
    </tr>
    <tr>
      <th>1004</th>
      <td>(509529,)</td>
      <td>NRCS</td>
      <td>3.039095e-12</td>
      <td>0.428779</td>
      <td>0.000103</td>
      <td>1.383180</td>
      <td>0.175133</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1005</th>
      <td>(509532,)</td>
      <td>NRCS</td>
      <td>3.172415e-12</td>
      <td>0.378365</td>
      <td>0.000079</td>
      <td>1.374540</td>
      <td>0.230885</td>
      <td>1.250000</td>
    </tr>
    <tr>
      <th>1006</th>
      <td>(509482,)</td>
      <td>NRCS</td>
      <td>4.654687e-12</td>
      <td>0.369886</td>
      <td>0.000092</td>
      <td>1.397760</td>
      <td>0.207877</td>
      <td>1.205000</td>
    </tr>
    <tr>
      <th>1007</th>
      <td>(498208,)</td>
      <td>NRCS</td>
      <td>9.122162e-13</td>
      <td>0.237423</td>
      <td>0.000072</td>
      <td>1.395746</td>
      <td>0.219597</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1008</th>
      <td>(509559,)</td>
      <td>NRCS</td>
      <td>2.375523e-13</td>
      <td>0.271630</td>
      <td>0.000079</td>
      <td>1.340429</td>
      <td>0.241801</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1009</th>
      <td>(498231,)</td>
      <td>NRCS</td>
      <td>5.850942e-12</td>
      <td>0.356163</td>
      <td>0.000157</td>
      <td>1.406091</td>
      <td>0.196811</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1010</th>
      <td>(509513,)</td>
      <td>NRCS</td>
      <td>1.526682e-12</td>
      <td>0.182238</td>
      <td>0.000087</td>
      <td>1.422578</td>
      <td>0.199783</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1011</th>
      <td>(509794,)</td>
      <td>NRCS</td>
      <td>2.006536e-12</td>
      <td>0.193350</td>
      <td>0.000104</td>
      <td>1.433685</td>
      <td>0.189314</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>1012</th>
      <td>(509479, 509481)</td>
      <td>NRCS</td>
      <td>7.504374e-13</td>
      <td>0.151250</td>
      <td>0.000078</td>
      <td>1.410010</td>
      <td>0.210870</td>
      <td>0.618125</td>
    </tr>
    <tr>
      <th>1013</th>
      <td>(498185,)</td>
      <td>NRCS</td>
      <td>1.590777e-13</td>
      <td>0.218625</td>
      <td>0.000081</td>
      <td>1.332817</td>
      <td>0.246665</td>
      <td>1.396471</td>
    </tr>
    <tr>
      <th>1014</th>
      <td>(509514,)</td>
      <td>NRCS</td>
      <td>5.262229e-12</td>
      <td>0.449752</td>
      <td>0.000221</td>
      <td>1.762072</td>
      <td>0.157366</td>
      <td>0.860000</td>
    </tr>
    <tr>
      <th>1015</th>
      <td>(509561,)</td>
      <td>NRCS</td>
      <td>1.554090e-12</td>
      <td>0.415245</td>
      <td>0.000140</td>
      <td>1.367408</td>
      <td>0.220962</td>
      <td>1.520000</td>
    </tr>
    <tr>
      <th>999</th>
      <td>(999,)</td>
      <td>SoilGrids</td>
      <td>1.000000e-16</td>
      <td>0.050000</td>
      <td>0.000019</td>
      <td>3.000000</td>
      <td>0.010000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the properties to disk for use in generating input file</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;subsurface_properties_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">,</span><span class="s1">&#39;CoalCreek&#39;</span><span class="p">,</span> <span class="s1">&#39;processed&#39;</span><span class="p">,</span> <span class="s1">&#39;watershed_subsurface_properties.csv&#39;</span><span class="p">)</span>
<span class="n">subsurface_props</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;subsurface_properties_filename&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Next we extrude the DEM to create a 3D mesh.</p>
<p>The most difficult aspect of extrusion is creating meshes that:</p>
<ol class="arabic simple">
<li><p>aren’t huge numbers of cells</p></li>
<li><p>aren’t huge cell thicknesses, especially near the surface</p></li>
<li><p>follow implied interfaces, e.g. bottom of soil and bottom of geologic layer</p></li>
</ol>
<p>This is an iterative process that requires some care and some art.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here we choose the bottom of the domain to be the maximum of the depth to bedrock.  </span>
<span class="c1"># This is really up to the user, but we are hard-coding this for this watershed_workflow.</span>
<span class="n">total_thickness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">DTB</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;max DTB: </span><span class="si">{</span><span class="n">total_thickness</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:14:01,910 - root - INFO: max DTB: 27.0 m
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate a dz structure for the top 2m of soil -- it appears from above that the soil thickness is uniformly 2m</span>
<span class="c1">#</span>
<span class="c1"># here we try for 10 cells, starting at 5cm at the top and going to 50cm at the bottom of the 2m thick soil</span>
<span class="n">dzs</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">optimize_dzs</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dzs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.05723957 0.07235405 0.10008891 0.1503918  0.24391084 0.37797867
 0.49803617 0.5       ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this looks like it would work out:</span>
<span class="n">dzs_soil</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a 2 m soil thickness and a maximum of 27 m depth to bedrock suggests a</span>
<span class="c1"># geologic layer of 13 * 2 m cells or something finer</span>
<span class="n">dzs_geo</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">]</span><span class="o">*</span><span class="mi">13</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># layer extrusion</span>
<span class="c1"># -- data structures needed for extrusion</span>
<span class="n">layer_types</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">layer_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">layer_ncells</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">layer_mat_ids</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># -- soil layer --</span>
<span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">dz</span> <span class="ow">in</span> <span class="n">dzs_soil</span><span class="p">:</span>
    <span class="n">depth</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dz</span>
    <span class="n">layer_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">layer_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
    <span class="n">layer_ncells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">br_or_geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">DTB</span><span class="p">,</span> <span class="n">geo_color_new</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
    <span class="n">soil_or_br_or_geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">soil_color_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">soil_thickness</span><span class="p">),</span>
                                 <span class="n">soil_color_new</span><span class="p">,</span>
                                 <span class="n">br_or_geo</span><span class="p">)</span>
    
    <span class="n">layer_mat_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">soil_or_br_or_geo</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dz</span>
    
<span class="c1"># -- geologic layer --</span>
<span class="k">for</span> <span class="n">dz</span> <span class="ow">in</span> <span class="n">dzs_geo</span><span class="p">:</span>
    <span class="n">depth</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dz</span>
    <span class="n">layer_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">layer_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
    <span class="n">layer_ncells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">layer_mat_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">DTB</span><span class="p">,</span> <span class="n">geo_color_new</span><span class="p">,</span> <span class="mi">999</span><span class="p">))</span>
    <span class="n">depth</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dz</span>

<span class="c1"># print the summary</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh3D</span><span class="o">.</span><span class="n">summarize_extrusion</span><span class="p">(</span><span class="n">layer_types</span><span class="p">,</span> <span class="n">layer_data</span><span class="p">,</span> 
                                            <span class="n">layer_ncells</span><span class="p">,</span> <span class="n">layer_mat_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:14:03,660 - root - INFO: Cell summary:
2023-07-19 19:14:03,662 - root - INFO: ------------------------------------------------------------
2023-07-19 19:14:03,666 - root - INFO: l_id	| c_id	|mat_id	| dz		| z_top
2023-07-19 19:14:03,669 - root - INFO: ------------------------------------------------------------
2023-07-19 19:14:03,672 - root - INFO:  00 	| 00 	| 1000 	|   0.050000 	|   0.000000
2023-07-19 19:14:03,676 - root - INFO:  01 	| 01 	| 1000 	|   0.050000 	|   0.050000
2023-07-19 19:14:03,679 - root - INFO:  02 	| 02 	| 1000 	|   0.050000 	|   0.100000
2023-07-19 19:14:03,686 - root - INFO:  03 	| 03 	| 1000 	|   0.120000 	|   0.150000
2023-07-19 19:14:03,690 - root - INFO:  04 	| 04 	| 1000 	|   0.230000 	|   0.270000
2023-07-19 19:14:03,693 - root - INFO:  05 	| 05 	| 1000 	|   0.500000 	|   0.500000
2023-07-19 19:14:03,698 - root - INFO:  06 	| 06 	|  103 	|   0.500000 	|   1.000000
2023-07-19 19:14:03,700 - root - INFO:  07 	| 07 	|  103 	|   0.500000 	|   1.500000
2023-07-19 19:14:03,704 - root - INFO:  08 	| 08 	|  103 	|   2.000000 	|   2.000000
2023-07-19 19:14:03,707 - root - INFO:  09 	| 09 	|  103 	|   2.000000 	|   4.000000
2023-07-19 19:14:03,713 - root - INFO:  10 	| 10 	|  103 	|   2.000000 	|   6.000000
2023-07-19 19:14:03,717 - root - INFO:  11 	| 11 	|  103 	|   2.000000 	|   8.000000
2023-07-19 19:14:03,720 - root - INFO:  12 	| 12 	|  103 	|   2.000000 	|  10.000000
2023-07-19 19:14:03,725 - root - INFO:  13 	| 13 	|  103 	|   2.000000 	|  12.000000
2023-07-19 19:14:03,729 - root - INFO:  14 	| 14 	|  103 	|   2.000000 	|  14.000000
2023-07-19 19:14:03,731 - root - INFO:  15 	| 15 	|  103 	|   2.000000 	|  16.000000
2023-07-19 19:14:03,734 - root - INFO:  16 	| 16 	|  103 	|   2.000000 	|  18.000000
2023-07-19 19:14:03,737 - root - INFO:  17 	| 17 	|  103 	|   2.000000 	|  20.000000
2023-07-19 19:14:03,740 - root - INFO:  18 	| 18 	|  999 	|   2.000000 	|  22.000000
2023-07-19 19:14:03,743 - root - INFO:  19 	| 19 	|  999 	|   2.000000 	|  24.000000
2023-07-19 19:14:03,749 - root - INFO:  20 	| 20 	|  999 	|   2.000000 	|  26.000000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extrude</span>
<span class="n">m3</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh3D</span><span class="o">.</span><span class="n">extruded_Mesh2D</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">layer_types</span><span class="p">,</span> <span class="n">layer_data</span><span class="p">,</span> 
                                             <span class="n">layer_ncells</span><span class="p">,</span> <span class="n">layer_mat_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # add back on land cover side sets</span>
<span class="c1"># surf_ss = m3.side_sets[1]</span>

<span class="c1"># for index, name in zip(nlcd_indices, nlcd_labels):</span>
<span class="c1">#     where = np.where(lc == index)[0]</span>
<span class="c1">#     ss = watershed_workflow.mesh.SideSet(name, int(index), </span>
<span class="c1">#                             [surf_ss.cell_list[w] for w in where],</span>
<span class="c1">#                             [surf_ss.side_list[w] for w in where])        </span>
<span class="c1">#     m3.side_sets.append(ss)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;total number of cells: </span><span class="si">{</span><span class="n">m3</span><span class="o">.</span><span class="n">num_cells</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2D labeled sets&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">labeled_sets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">setid</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">entity</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">ent_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> : &quot;</span><span class="si">{</span><span class="n">ls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extruded 3D labeled sets&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------&#39;</span><span class="p">)</span>
<span class="n">ls</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m3</span><span class="o">.</span><span class="n">labeled_sets</span><span class="p">:</span>
    <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;setid&#39;</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">setid</span><span class="p">,</span> <span class="s1">&#39;entity&#39;</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">entity</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">setid</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">entity</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ent_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> : &quot;</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extruded 3D side sets&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------&#39;</span><span class="p">)</span>
<span class="n">ss</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m3</span><span class="o">.</span><span class="n">side_sets</span><span class="p">:</span>
    <span class="n">ss</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;setid&#39;</span><span class="p">:</span><span class="n">i</span><span class="o">.</span><span class="n">setid</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">setid</span><span class="si">}</span><span class="s1"> : FACE : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">cell_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> : &quot;</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>total number of cells: 117810
---------------
2D labeled sets
---------------
10000 : CELL : 5610 : &quot;140200010204&quot;
10001 : CELL : 5610 : &quot;140200010204 surface&quot;
10002 : FACE : 182 : &quot;140200010204 boundary&quot;
10003 : FACE : 12 : &quot;140200010204 outlet&quot;
10004 : FACE : 12 : &quot;surface domain outlet&quot;
8 : CELL : 3449 : &quot;MODIS Woody Savannas&quot;
9 : CELL : 148 : &quot;MODIS Savannas&quot;
10 : CELL : 2013 : &quot;MODIS Grasslands&quot;

Extruded 3D labeled sets
------------------------
10000 : CELL : 117810 : &quot;140200010204&quot;

Extruded 3D side sets
---------------------
1 : FACE : 5610 : &quot;bottom&quot;
2 : FACE : 5610 : &quot;surface&quot;
3 : FACE : 3822 : &quot;external_sides&quot;
10001 : FACE : 5610 : &quot;140200010204 surface&quot;
10002 : FACE : 3822 : &quot;140200010204 boundary&quot;
10003 : FACE : 252 : &quot;140200010204 outlet&quot;
10004 : FACE : 252 : &quot;surface domain outlet&quot;
8 : FACE : 3449 : &quot;MODIS Woody Savannas&quot;
9 : FACE : 148 : &quot;MODIS Savannas&quot;
10 : FACE : 2013 : &quot;MODIS Grasslands&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;labeled_sets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;side_sets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span>
</pre></div>
</div>
</div>
</div>
<section id="save-mesh-file">
<h3>Save mesh file<a class="headerlink" href="#save-mesh-file" title="Permalink to this heading">#</a></h3>
<p>This will write the 3D mesh to ExodusII using arbitrary polyhedra specification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mesh_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">,</span><span class="s1">&#39;CoalCreek&#39;</span><span class="p">,</span> <span class="s1">&#39;processed&#39;</span><span class="p">,</span><span class="s1">&#39;watershed_mesh.exo&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mesh_filename&#39;</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">m3</span><span class="o">.</span><span class="n">write_exodus</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mesh_filename&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You are using exodus.py v 1.20.10 (seacas-py3), a python wrapper of some of the exodus library.

Copyright (c) 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021 National Technology &amp;
Engineering Solutions of Sandia, LLC (NTESS).  Under the terms of
Contract DE-NA0003525 with NTESS, the U.S. Government retains certain
rights in this software.

Opening exodus file: ../../data/examples/CoalCreek/processed/watershed_mesh.exo
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-07-19 19:15:40,272 - root - INFO: adding side set: 1
2023-07-19 19:15:44,048 - root - INFO: adding side set: 2
2023-07-19 19:15:48,152 - root - INFO: adding side set: 3
2023-07-19 19:15:51,894 - root - INFO: adding side set: 10001
2023-07-19 19:15:56,183 - root - INFO: adding side set: 10002
2023-07-19 19:16:00,163 - root - INFO: adding side set: 10003
2023-07-19 19:16:03,759 - root - INFO: adding side set: 10004
2023-07-19 19:16:07,463 - root - INFO: adding side set: 8
2023-07-19 19:16:11,086 - root - INFO: adding side set: 9
2023-07-19 19:16:14,985 - root - INFO: adding side set: 10
2023-07-19 19:16:19,339 - root - INFO: adding elem set: 10000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Closing exodus file: ../../data/examples/CoalCreek/processed/watershed_mesh.exo
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_date</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_date</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;origin_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin_date</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;catchment_labels&#39;: [&#39;140200010204&#39;],
 &#39;nlcd_indices&#39;: [8, 9, 10],
 &#39;nlcd_labels&#39;: [&#39;MODIS Woody Savannas&#39;, &#39;MODIS Savannas&#39;, &#39;MODIS Grasslands&#39;],
 &#39;LAI_filename&#39;: &#39;../../data/examples/CoalCreek/processed/watershed_lai_raw.h5&#39;,
 &#39;LAI_typical_filename&#39;: &#39;../../data/examples/CoalCreek/processed/watershed_lai_typical.h5&#39;,
 &#39;subsurface_properties_filename&#39;: &#39;../../data/examples/CoalCreek/processed/watershed_subsurface_properties.csv&#39;,
 &#39;labeled_sets&#39;: {&#39;140200010204&#39;: {&#39;setid&#39;: 10000, &#39;entity&#39;: &#39;CELL&#39;}},
 &#39;side_sets&#39;: {&#39;bottom&#39;: {&#39;setid&#39;: 1},
  &#39;surface&#39;: {&#39;setid&#39;: 2},
  &#39;external_sides&#39;: {&#39;setid&#39;: 3},
  &#39;140200010204 surface&#39;: {&#39;setid&#39;: 10001},
  &#39;140200010204 boundary&#39;: {&#39;setid&#39;: 10002},
  &#39;140200010204 outlet&#39;: {&#39;setid&#39;: 10003},
  &#39;surface domain outlet&#39;: {&#39;setid&#39;: 10004},
  &#39;MODIS Woody Savannas&#39;: {&#39;setid&#39;: 8},
  &#39;MODIS Savannas&#39;: {&#39;setid&#39;: 9},
  &#39;MODIS Grasslands&#39;: {&#39;setid&#39;: 10}},
 &#39;mesh_filename&#39;: &#39;../../data/examples/CoalCreek/processed/watershed_mesh.exo&#39;,
 &#39;start_date&#39;: &#39;2015-10-1&#39;,
 &#39;end_date&#39;: &#39;2016-10-1&#39;,
 &#39;origin_date&#39;: &#39;1980-1-1&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save dictionary to a file</span>
<span class="c1"># config[&#39;config_file&#39;] = os.path.join(&#39;..&#39;, &#39;..&#39;, &#39;data&#39;, &#39;examples&#39;,&#39;CoalCreek&#39;, &#39;processed&#39;,&#39;config.yaml&#39;)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "watershed_workflow"
        },
        kernelOptions: {
            name: "watershed_workflow",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'watershed_workflow'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">ATS modeling workflow</p>
      </div>
    </a>
    <a class="right-next"
       href="2-daymet.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Download Daymet</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sources-and-setup">Sources and setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sources">Sources</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-the-surface-mesh">Generate the surface mesh</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#meshing">Meshing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-watershed-outlet-optional">Add watershed outlet (optional)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surface-properties">Surface properties</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#land-cover">Land Cover</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lai">LAI</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#subsurface-properties">Subsurface properties</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ssurgo-soil-properties">SSURGO Soil Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#glhymps-geologic-layer">GLHYMPS geologic layer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#depth-to-bedrock">Depth-to-bedrock</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mesh-extrusion">Mesh extrusion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-mesh-file">Save mesh file</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pin Shuai, Ethan Coon, and etc.
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>