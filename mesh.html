
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Example: mesh a delineated watershed &#8212; ATS workflow</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Download Daymet" href="daymet.html" />
    <link rel="prev" title="ATS modeling workflow" href="intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">ATS workflow</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    ATS modeling workflow
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Model Setup
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Example: mesh a delineated watershed
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="daymet.html">
   Download Daymet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MODIS.html">
   Download and post-process MODIS LAI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="write_ATS_input.html">
   Write ATS input file
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Execute Model
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="run.html">
   Run ATS model
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Model Post-processes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_surface.html">
   Plot surface variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plot_subsurface.html">
   Plot subsurface variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="model_evaluation.html">
   Model evaluation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Sensitivity Analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sensitivity_analysis.html">
   Sensitivity analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Model Calibration
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="model_calibration.html">
   Model calibration using Machine Learning
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/mesh.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fmesh.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/mesh.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sources-and-setup">
   Sources and setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generate-the-surface-mesh">
   Generate the surface mesh
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#surface-properties">
   Surface properties
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subsurface-properties">
   Subsurface properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ssurgo-soil-properties">
     SSURGO Soil Properties
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#glyhmps-geologic-layer">
     GLYHMPS geologic layer
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#depth-to-bedrock">
   Depth-to-bedrock
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mesh-extrusion">
   Mesh extrusion
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Example: mesh a delineated watershed</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sources-and-setup">
   Sources and setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generate-the-surface-mesh">
   Generate the surface mesh
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#surface-properties">
   Surface properties
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subsurface-properties">
   Subsurface properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ssurgo-soil-properties">
     SSURGO Soil Properties
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#glyhmps-geologic-layer">
     GLYHMPS geologic layer
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#depth-to-bedrock">
   Depth-to-bedrock
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mesh-extrusion">
   Mesh extrusion
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="example-mesh-a-delineated-watershed">
<h1>Example: mesh a delineated watershed<a class="headerlink" href="#example-mesh-a-delineated-watershed" title="Permalink to this headline">#</a></h1>
<p>Here we mesh the <a class="reference external" href="https://www.srs.fs.usda.gov/coweeta/">Coweeta Hydrologic Laboratory</a> as an example of how to pull data in from default locations and generate a fully functional ATS mesh.</p>
<p>This might be the worst example to use to learn how to use Watershed Workflows.  But it is useful to demonstrate the breadth of problems this project was intended to solve.</p>
<p>This includes a range of datasets:</p>
<ul class="simple">
<li><p>NHD Plus for river network</p></li>
<li><p>NRCS soils data for soil types</p></li>
<li><p>NLCD for land cover/transpiration/rooting depths</p></li>
<li><p>NED for elevation</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span> <span class="k">as</span> <span class="n">pcm</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="kc">None</span>


<span class="kn">import</span> <span class="nn">watershed_workflow</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.source_list</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.ui</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.colors</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.condition</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.mesh</span>
<span class="kn">import</span> <span class="nn">watershed_workflow.split_hucs</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">figsize_3d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="sources-and-setup">
<h2>Sources and setup<a class="headerlink" href="#sources-and-setup" title="Permalink to this headline">#</a></h2>
<p>Next we set up the source watershed and coordinate system and all data sources for our mesh.  We will use the CRS that is included in the shapefile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># specify the input shapefile and a hint as to what HUC it is in.</span>
<span class="n">coweeta_shapefile</span> <span class="o">=</span> <span class="s1">&#39;Coweeta/input_data/coweeta_basin.shp&#39;</span>
<span class="n">hint</span> <span class="o">=</span> <span class="s1">&#39;0601&#39;</span>  <span class="c1"># hint: HUC 4 containing this shape.  </span>
               <span class="c1"># This is necessary to avoid downloading all HUCs to search for this shape</span>
<span class="n">simplify</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># length scale to target average edge</span>

<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Meshing shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coweeta_shapefile</span><span class="p">))</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># get the shape and crs of the shape</span>
<span class="n">crs</span><span class="p">,</span> <span class="n">coweeta</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_split_form_shapes</span><span class="p">(</span><span class="n">coweeta_shapefile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:02,553 - root - INFO: 
2022-02-28 14:55:02,555 - root - INFO: Meshing shape: Coweeta/input_data/coweeta_basin.shp
2022-02-28 14:55:02,556 - root - INFO: ==============================
2022-02-28 14:55:02,557 - root - INFO: 
2022-02-28 14:55:02,557 - root - INFO: Loading shapes
2022-02-28 14:55:02,558 - root - INFO: ------------------------------
2022-02-28 14:55:02,559 - root - INFO: Loading file: &#39;Coweeta/input_data/coweeta_basin.shp&#39;
2022-02-28 14:55:02,573 - root - INFO: ... found 1 shapes
2022-02-28 14:55:02,574 - root - INFO: Converting to shapely
</pre></div>
</div>
</div>
</div>
<p>A wide range of data sources are available; here we use the defaults except for using NHD Plus for watershed boundaries and hydrography (the default is NHD, which is lower resolution and therefore smaller download sizes).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up a dictionary of source objects</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">get_default_sources</span><span class="p">()</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;depth to bedrock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerSoilGrids2017</span><span class="p">()</span>

<span class="c1">#</span>
<span class="c1"># This demo uses a few datasets that have been clipped out of larger, national</span>
<span class="c1"># datasets and are distributed with the code.  This is simply to save download</span>
<span class="c1"># time for this simple problem and to lower the barrier for trying out</span>
<span class="c1"># Watershed Workflow.  A more typical workflow would delete these lines (as </span>
<span class="c1"># these files would not exist for other watersheds).</span>
<span class="c1">#</span>
<span class="c1"># The default versions of these download large raster and shapefile files that</span>
<span class="c1"># are defined over a very large region (globally or the entire US).</span>
<span class="c1">#</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;land cover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerRaster</span><span class="p">(</span><span class="s1">&#39;Coweeta/input_data/land_cover/land_cover.tif&#39;</span><span class="p">)</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;geologic structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerGLHYMPS</span><span class="p">(</span><span class="s1">&#39;Coweeta/input_data/GLHYMPS/GLHYMPS.shp&#39;</span><span class="p">)</span>
<span class="n">sources</span><span class="p">[</span><span class="s1">&#39;depth to bedrock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">FileManagerRaster</span><span class="p">(</span><span class="s1">&#39;Coweeta/input_data/DTB/DTB.tif&#39;</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">source_list</span><span class="o">.</span><span class="n">log_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:02,586 - root - INFO: Using sources:
2022-02-28 14:55:02,587 - root - INFO: --------------
2022-02-28 14:55:02,588 - root - INFO: HUC: National Watershed Boundary Dataset (WBD)
2022-02-28 14:55:02,588 - root - INFO: hydrography: National Hydrography Dataset (NHD)
2022-02-28 14:55:02,589 - root - INFO: DEM: National Elevation Dataset (NED)
2022-02-28 14:55:02,589 - root - INFO: soil structure: National Resources Conservation Service Soil Survey (NRCS Soils)
2022-02-28 14:55:02,590 - root - INFO: geologic structure: Coweeta/input_data/GLHYMPS/GLHYMPS.shp
2022-02-28 14:55:02,591 - root - INFO: land cover: raster
2022-02-28 14:55:02,592 - root - INFO: soil thickness: None
2022-02-28 14:55:02,592 - root - INFO: meteorology: DayMet 1km
2022-02-28 14:55:02,593 - root - INFO: depth to bedrock: raster
</pre></div>
</div>
</div>
</div>
</section>
<section id="generate-the-surface-mesh">
<h2>Generate the surface mesh<a class="headerlink" href="#generate-the-surface-mesh" title="Permalink to this headline">#</a></h2>
<p>First we’ll generate the flattened, 2D triangulation, which builds on hydrography data.  Then we download a digital elevation map from the National Elevation Dataset, and extrude that 2D triangulation to a 3D surface mesh based on interpolation between pixels of the DEM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find what HUC our shape is in</span>
<span class="n">huc</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">find_huc</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;HUC&#39;</span><span class="p">],</span> <span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">shrink_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found Coweeta in HUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">huc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:02,608 - root - INFO: 
2022-02-28 14:55:02,608 - root - INFO: Loading HUC 0601
2022-02-28 14:55:02,609 - root - INFO: ------------------------------
2022-02-28 14:55:02,610 - root - INFO: 
2022-02-28 14:55:02,611 - root - INFO: Loading level 4 HUCs in 0601
2022-02-28 14:55:02,612 - root - INFO: ------------------------------
2022-02-28 14:55:02,614 - root - INFO: Using HUC file &quot;/Users/uec/code/watershed_workflow/data-library/hydrography/WBD_06_GDB/WBD_06.gdb&quot;
2022-02-28 14:55:02,726 - root - INFO: ... found 1 HUCs
2022-02-28 14:55:02,727 - root - INFO:   -- 0601
2022-02-28 14:55:02,728 - root - INFO: Converting to out_crs
2022-02-28 14:55:02,767 - root - INFO: Converting to shapely
2022-02-28 14:55:02,784 - root - INFO: ... found 1
2022-02-28 14:55:02,790 - root - INFO: 
2022-02-28 14:55:02,790 - root - INFO: Loading level 6 HUCs in 0601
2022-02-28 14:55:02,791 - root - INFO: ------------------------------
2022-02-28 14:55:02,793 - root - INFO: Using HUC file &quot;/Users/uec/code/watershed_workflow/data-library/hydrography/WBD_06_GDB/WBD_06.gdb&quot;
2022-02-28 14:55:02,837 - root - INFO: ... found 2 HUCs
2022-02-28 14:55:02,837 - root - INFO:   -- 060102
2022-02-28 14:55:02,838 - root - INFO:   -- 060101
2022-02-28 14:55:02,839 - root - INFO: Converting to out_crs
2022-02-28 14:55:02,901 - root - INFO: Converting to shapely
2022-02-28 14:55:02,932 - root - INFO: 
2022-02-28 14:55:02,933 - root - INFO: Loading level 8 HUCs in 060102
2022-02-28 14:55:02,933 - root - INFO: ------------------------------
2022-02-28 14:55:02,935 - root - INFO: Using HUC file &quot;/Users/uec/code/watershed_workflow/data-library/hydrography/WBD_06_GDB/WBD_06.gdb&quot;
2022-02-28 14:55:03,003 - root - INFO: ... found 8 HUCs
2022-02-28 14:55:03,004 - root - INFO:   -- 06010201
2022-02-28 14:55:03,005 - root - INFO:   -- 06010207
2022-02-28 14:55:03,005 - root - INFO:   -- 06010208
2022-02-28 14:55:03,006 - root - INFO:   -- 06010205
2022-02-28 14:55:03,007 - root - INFO:   -- 06010202
2022-02-28 14:55:03,007 - root - INFO:   -- 06010203
2022-02-28 14:55:03,008 - root - INFO:   -- 06010204
2022-02-28 14:55:03,009 - root - INFO:   -- 06010206
2022-02-28 14:55:03,011 - root - INFO: Converting to out_crs
2022-02-28 14:55:03,095 - root - INFO: Converting to shapely
2022-02-28 14:55:03,126 - root - INFO: 
2022-02-28 14:55:03,127 - root - INFO: Loading level 10 HUCs in 06010202
2022-02-28 14:55:03,127 - root - INFO: ------------------------------
2022-02-28 14:55:03,129 - root - INFO: Using HUC file &quot;/Users/uec/code/watershed_workflow/data-library/hydrography/WBD_06_GDB/WBD_06.gdb&quot;
2022-02-28 14:55:03,240 - root - INFO: ... found 5 HUCs
2022-02-28 14:55:03,241 - root - INFO:   -- 0601020203
2022-02-28 14:55:03,241 - root - INFO:   -- 0601020204
2022-02-28 14:55:03,241 - root - INFO:   -- 0601020201
2022-02-28 14:55:03,242 - root - INFO:   -- 0601020202
2022-02-28 14:55:03,243 - root - INFO:   -- 0601020205
2022-02-28 14:55:03,244 - root - INFO: Converting to out_crs
2022-02-28 14:55:03,267 - root - INFO: Converting to shapely
2022-02-28 14:55:03,274 - root - INFO: 
2022-02-28 14:55:03,275 - root - INFO: Loading level 12 HUCs in 0601020201
2022-02-28 14:55:03,276 - root - INFO: ------------------------------
2022-02-28 14:55:03,278 - root - INFO: Using HUC file &quot;/Users/uec/code/watershed_workflow/data-library/hydrography/WBD_06_GDB/WBD_06.gdb&quot;
2022-02-28 14:55:03,463 - root - INFO: ... found 6 HUCs
2022-02-28 14:55:03,464 - root - INFO:   -- 060102020106
2022-02-28 14:55:03,464 - root - INFO:   -- 060102020104
2022-02-28 14:55:03,465 - root - INFO:   -- 060102020105
2022-02-28 14:55:03,465 - root - INFO:   -- 060102020101
2022-02-28 14:55:03,466 - root - INFO:   -- 060102020102
2022-02-28 14:55:03,466 - root - INFO:   -- 060102020103
2022-02-28 14:55:03,468 - root - INFO: Converting to out_crs
2022-02-28 14:55:03,486 - root - INFO: Converting to shapely
2022-02-28 14:55:03,497 - root - INFO: Found Coweeta in HUC: 060102020103
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rivers</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">rivers</span><span class="p">:</span>
    <span class="c1"># download/collect the river network within that shape&#39;s bounds</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">reaches</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_reaches</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;hydrography&#39;</span><span class="p">],</span> <span class="n">huc</span><span class="p">,</span> 
                                      <span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span>
    <span class="c1"># simplify and prune rivers not IN the shape, constructing a tree-like data structure</span>
    <span class="c1"># for the river network</span>
    <span class="n">rivers</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">construct_rivers</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">reaches</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">simplify</span><span class="p">)</span>
    <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">simplify_hucs</span><span class="o">=</span><span class="n">simplify</span><span class="p">,</span> <span class="n">simplify_rivers</span><span class="o">=</span><span class="n">simplify</span><span class="p">,</span>
                                <span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cut_intersections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">rivers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">split_hucs</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">simplify</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:03,505 - root - INFO: 
2022-02-28 14:55:03,506 - root - INFO: Loading Hydrography
2022-02-28 14:55:03,507 - root - INFO: ------------------------------
2022-02-28 14:55:03,508 - root - INFO: Loading streams in HUC 060102020103
2022-02-28 14:55:03,508 - root - INFO:          and/or bounds (273971.0911428096, 3878839.6361173145, 279140.9150949494, 3883953.7853134344)
2022-02-28 14:55:03,510 - root - INFO:   Using Hydrography file &quot;/Users/uec/code/watershed_workflow/data-library/hydrography/NHD_H_06010202_GDB/NHD_H_06010202.gdb&quot;
2022-02-28 14:55:03,511 - root - INFO:   National Hydrography Dataset (NHD): opening &#39;/Users/uec/code/watershed_workflow/data-library/hydrography/NHD_H_06010202_GDB/NHD_H_06010202.gdb&#39; layer &#39;NHDFlowline&#39; for streams in &#39;(273971.0911428096, 3878839.6361173145, 279140.9150949494, 3883953.7853134344)&#39;
2022-02-28 14:55:03,578 - root - INFO:   Filtering reaches not in-network
2022-02-28 14:55:03,579 - root - INFO: ... found 35 reaches
2022-02-28 14:55:03,579 - root - INFO: Converting to shapely
2022-02-28 14:55:03,596 - root - INFO: Converting to out_crs
2022-02-28 14:55:03,605 - root - INFO: 
2022-02-28 14:55:03,606 - root - INFO: Constructing river network
2022-02-28 14:55:03,606 - root - INFO: ------------------------------
2022-02-28 14:55:03,607 - root - INFO: Filtering reaches outside of the HUC space
2022-02-28 14:55:03,610 - root - INFO:   ...filtering
2022-02-28 14:55:03,619 - root - INFO: ... filtered from 35 to 21 reaches.
2022-02-28 14:55:03,620 - root - INFO: Generating the river tree
2022-02-28 14:55:03,624 - root - INFO: 
2022-02-28 14:55:03,625 - root - INFO: Simplifying
2022-02-28 14:55:03,626 - root - INFO: ------------------------------
2022-02-28 14:55:03,627 - root - INFO: Simplifying rivers
2022-02-28 14:55:03,636 - root - INFO: Simplifying HUCs
2022-02-28 14:55:03,638 - root - INFO: Snapping river and HUC (nearly) coincident nodes
2022-02-28 14:55:03,641 - root - INFO:   snapping polygon segment boundaries to river endpoints
2022-02-28 14:55:03,647 - root - INFO:   snapping river endpoints to the polygon
2022-02-28 14:55:03,670 - root - INFO:   cutting at crossings
2022-02-28 14:55:03,684 - root - INFO:   filtering rivers to HUC
2022-02-28 14:55:03,685 - root - INFO:   ...filtering
2022-02-28 14:55:03,689 - root - INFO: 
2022-02-28 14:55:03,689 - root - INFO: Simplification Diagnostics
2022-02-28 14:55:03,690 - root - INFO: ------------------------------
2022-02-28 14:55:03,694 - root - INFO:   river min seg length: 87.37142879298393
2022-02-28 14:55:03,695 - root - INFO:   river median seg length: 160.85900507901667
2022-02-28 14:55:03,697 - root - INFO:   HUC min seg length: 42.195003270380795
2022-02-28 14:55:03,698 - root - INFO:   HUC median seg length: 55.87002795054712
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot what we have so far -- an image of the HUC and its stream network</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/Shared/ornldev/code/miniconda3/envs/watershed_workflow_DEV-2021-11-10/lib/python3.9/site-packages/pyproj/crs/crs.py:1256: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  return self._crs.to_proj4(version=version)
</pre></div>
</div>
<img alt="_images/mesh_10_1.png" src="_images/mesh_10_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># form a triangulation on the shape + river network</span>

<span class="c1"># triangulation refinement:</span>
<span class="c1"># Refine triangles if their area (in m^2) is greater than A(d), where d is the </span>
<span class="c1"># distance from the triangle centroid to the nearest stream.</span>
<span class="c1"># A(d) is a piecewise linear function -- A = A0 if d &lt;= d0, A = A1 if d &gt;= d1, and</span>
<span class="c1"># linearly interpolates between the two endpoints.</span>
<span class="n">d0</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">d1</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">A0</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">A1</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="c1">#A0 = 500; A1 = 2500</span>
<span class="c1">#A0 = 100; A1 = 500</span>

<span class="c1"># Refine triangles if they get too acute</span>
<span class="n">min_angle</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># degrees</span>

<span class="c1"># make 2D mesh</span>
<span class="n">mesh_points2</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">rivers</span><span class="p">,</span> 
                                               <span class="n">refine_distance</span><span class="o">=</span><span class="p">[</span><span class="n">d0</span><span class="p">,</span><span class="n">A0</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">A1</span><span class="p">],</span>
                                               <span class="n">refine_min_angle</span><span class="o">=</span><span class="n">min_angle</span><span class="p">,</span>
                                               <span class="n">diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#mesh_points2, mesh_tris, d = watershed_workflow.triangulate(coweeta, rivers,</span>
<span class="c1">#                                                 refine_max_area=100000,</span>
<span class="c1">#                                                 enforce_delaunay=True,</span>
<span class="c1">#                                                 diagnostics=True)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:03,931 - root - INFO: 
2022-02-28 14:55:03,932 - root - INFO: Meshing
2022-02-28 14:55:03,932 - root - INFO: ------------------------------
2022-02-28 14:55:03,943 - root - INFO: Triangulating...
2022-02-28 14:55:03,944 - root - INFO:    62 points and 62 facets
2022-02-28 14:55:03,945 - root - INFO:  checking graph consistency
2022-02-28 14:55:03,946 - root - INFO:  tolerance is set to 1
2022-02-28 14:55:03,947 - root - INFO:  building graph data structures
2022-02-28 14:55:03,949 - root - INFO:  triangle.build...
2022-02-28 14:55:07,796 - root - INFO:   ...built: 8086 mesh points and 15945 triangles
2022-02-28 14:55:07,797 - root - INFO: Plotting triangulation diagnostics
2022-02-28 14:55:08,806 - root - INFO:   min area = 289.77447509765625
2022-02-28 14:55:08,806 - root - INFO:   max area = 4979.40869140625
</pre></div>
</div>
<img alt="_images/mesh_11_1.png" src="_images/mesh_11_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get a raster for the elevation map, based on NED</span>
<span class="n">dem_profile</span><span class="p">,</span> <span class="n">dem</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_raster_on_shape</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;DEM&#39;</span><span class="p">],</span> <span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">)</span>

<span class="c1"># elevate the triangle nodes to the dem</span>
<span class="n">mesh_points3</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">elevate</span><span class="p">(</span><span class="n">mesh_points2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">dem</span><span class="p">,</span> <span class="n">dem_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:09,120 - root - INFO: 
2022-02-28 14:55:09,121 - root - INFO: Loading Raster
2022-02-28 14:55:09,122 - root - INFO: ------------------------------
2022-02-28 14:55:09,123 - root - INFO: Collecting raster
2022-02-28 14:55:09,127 - root - INFO: Collecting DEMs to tile bounds: [-83.48845037186388, 35.01734099944037, -83.41165773504302, 35.08381933600275]
2022-02-28 14:55:09,128 - root - INFO:   Need:
2022-02-28 14:55:09,129 - root - INFO:     /Users/uec/code/watershed_workflow/data-library/dem/USGS_NED_1as_n36_w084.tif
2022-02-28 14:55:09,129 - root - INFO: source files already exist!
2022-02-28 14:55:09,151 - root - INFO: ... got raster of shape: (239, 276)
2022-02-28 14:55:09,152 - root - INFO: ... got raster bounds: (-83.48845037186388, 35.08381933600275, -83.41178370519467, 35.01743044711165)
2022-02-28 14:55:09,153 - root - INFO: 
2022-02-28 14:55:09,154 - root - INFO: Elevating Triangulation to DEM
2022-02-28 14:55:09,154 - root - INFO: ------------------------------
</pre></div>
</div>
</div>
</div>
<p>Plotting the resulting mesh can be done in a variety of ways, including both 3D plots and mapview.  We show both here, but hereafter use mapview plots as they are a bit clearer (if not so flashy)…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the resulting surface mesh</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize_3d</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.23</span><span class="p">,</span><span class="mf">0.18</span><span class="p">,</span><span class="mf">0.58</span><span class="p">,</span><span class="mf">0.03</span><span class="p">])</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> 
                     <span class="n">triangles</span><span class="o">=</span><span class="n">mesh_tris</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
                     <span class="n">edgecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">.2</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;elevation [m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/Shared/ornldev/code/watershed_workflow/repos/master/watershed_workflow/plot.py:110: MatplotlibDeprecationWarning: Axes3D(fig) adding itself to the figure is deprecated since 3.4. Pass the keyword argument auto_add_to_figure=False and use fig.add_axes(ax) to suppress this warning. The default value of auto_add_to_figure will change to False in mpl3.5 and True values will no longer work in 3.6.  This is consistent with other Axes classes.
  ax = Axes3D(fig, rect=window)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Text(3878000.0, 0, &#39;&#39;),
 Text(3879000.0, 0, &#39;&#39;),
 Text(3880000.0, 0, &#39;&#39;),
 Text(3881000.0, 0, &#39;&#39;),
 Text(3882000.0, 0, &#39;&#39;),
 Text(3883000.0, 0, &#39;&#39;),
 Text(3884000.0, 0, &#39;&#39;),
 Text(3885000.0, 0, &#39;&#39;)]
</pre></div>
</div>
<img alt="_images/mesh_14_2.png" src="_images/mesh_14_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the resulting surface mesh</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.8</span><span class="p">])</span>
<span class="c1">#ax2 = watershed_workflow.plot.get_ax(crs,fig, window=[0.65,0.05,0.3,0.5])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">0.65</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>
<span class="n">cbax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.05</span><span class="p">])</span>

<span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="mf">275900.</span><span class="p">,</span> <span class="mf">276400.</span><span class="p">)</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3882300.</span><span class="p">,</span> <span class="mf">3883000.</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbax</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;datalim&#39;</span><span class="p">)</span>

<span class="n">mp2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hucs</span><span class="p">(</span><span class="n">coweeta</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">rivers</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">indicate_inset_zoom</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;elevation [m]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(273632.49028452876, 281081.70602489595)
(3878085.9481054433, 3884707.4732079916)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;elevation [m]&#39;)
</pre></div>
</div>
<img alt="_images/mesh_15_2.png" src="_images/mesh_15_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the 2D mesh</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh2D</span><span class="p">(</span><span class="n">mesh_points3</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(</span><span class="n">mesh_tris</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># hydrologically condition the mesh, removing pits</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">condition</span><span class="o">.</span><span class="n">fill_pits</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span>

<span class="c1"># plot the change between the two meshes</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">)</span>
<span class="n">diff</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mesh_points3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max diff = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> 
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;conditioned dz&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>max diff =  6.589355426081738
</pre></div>
</div>
<img alt="_images/mesh_17_1.png" src="_images/mesh_17_1.png" />
</div>
</div>
</section>
<section id="surface-properties">
<h2>Surface properties<a class="headerlink" href="#surface-properties" title="Permalink to this headline">#</a></h2>
<p>Meshes interact with data to provide forcing, parameters, and more in the actual simulation.  Specifically, we need vegetation type on the surface to provide information about transpiration and subsurface structure to provide information about water retention curves, etc.</p>
<p>We’ll start by downloading and collecting land cover from the NLCD dataset, and generate sets for each land cover type that cover the surface.  Likely these will be some combination of grass, deciduous forest, coniferous forest, and mixed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the NLCD raster</span>
<span class="n">lc_profile</span><span class="p">,</span> <span class="n">lc_raster</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_raster_on_shape</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;land cover&#39;</span><span class="p">],</span> 
                                                     <span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">)</span>

<span class="c1"># resample the raster to the triangles</span>
<span class="n">lc</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> <span class="n">lc_raster</span><span class="p">,</span> <span class="n">lc_profile</span><span class="p">)</span>

<span class="c1"># what land cover types did we get?</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found land cover dtypes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found land cover types: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lc</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 14:55:12,472 - root - INFO: 
2022-02-28 14:55:12,473 - root - INFO: Loading Raster
2022-02-28 14:55:12,474 - root - INFO: ------------------------------
2022-02-28 14:55:12,475 - root - INFO: Collecting raster
2022-02-28 14:55:12,503 - root - INFO: bounds in my_crs: (1129295.2795605154, 1404623.589663599, 1134445.5249579642, 1410000.8473879488)
2022-02-28 14:55:12,505 - root - INFO: ... got raster of shape: (180, 173)
2022-02-28 14:55:12,514 - root - INFO: ... got raster bounds: (1129275.0, 1410015.0, 1134465.0, 1404615.0)
2022-02-28 14:55:12,800 - root - INFO: Found land cover dtypes: uint8
2022-02-28 14:55:12,801 - root - INFO: Found land cover types: {41, 42, 43, 81, 52, 21, 22, 23}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the NLCD data</span>

<span class="c1"># -- get the NLCD colormap which uses official NLCD colors and labels</span>
<span class="n">nlcd_indices</span><span class="p">,</span> <span class="n">nlcd_cmap</span><span class="p">,</span> <span class="n">nlcd_norm</span><span class="p">,</span> <span class="n">nlcd_ticks</span><span class="p">,</span> <span class="n">nlcd_labels</span> <span class="o">=</span> \
                <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_nlcd_colormap</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

<span class="c1"># this is just hacking the label names to make them display a bit neater for a cleaner plot.  Likely it </span>
<span class="c1"># should get put into the NLCD manager instead of here! See #8</span>
<span class="n">nlcd_labels_fw</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">nlcd_labels</span><span class="p">:</span>
    <span class="n">label_fw</span> <span class="o">=</span> <span class="n">label</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
            <span class="n">lsplit</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">label_fw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsplit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">label_fw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span>
                                      <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsplit</span><span class="p">[</span><span class="mi">2</span><span class="p">:])])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsplit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">label_fw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">lsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label_fw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsplit</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                          <span class="n">lsplit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">nlcd_labels_fw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_fw</span><span class="p">)</span>

<span class="c1"># plot the image</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">polys</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">nlcd_cmap</span><span class="p">,</span> 
                                     <span class="n">norm</span><span class="o">=</span><span class="n">nlcd_norm</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                                     <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">nlcd_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">nlcd_cmap</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">nlcd_ticks</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">nlcd_labels_fw</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;land cover index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;land cover index&#39;)
</pre></div>
</div>
<img alt="_images/mesh_20_1.png" src="_images/mesh_20_1.png" />
</div>
</div>
</section>
<section id="subsurface-properties">
<h2>Subsurface properties<a class="headerlink" href="#subsurface-properties" title="Permalink to this headline">#</a></h2>
<p>Get soil structure from SSURGO.  By soil structure, here we calculate, for each formation identified in SSURGO, a soil depth, porosity, permeability, and percent sand/silt/clay (which are then handed off to Rosetta to get a van Genuchten model).</p>
<p>Below this soil we also identify a geologic layer provided by GLHYMPS.  This provides information about the deeper subsurface.</p>
<section id="ssurgo-soil-properties">
<h3>SSURGO Soil Properties<a class="headerlink" href="#ssurgo-soil-properties" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the NRCS soils data as shapes and project it onto the mesh</span>

<span class="c1"># -- download the shapes</span>
<span class="n">soil_profile</span><span class="p">,</span> <span class="n">soil_survey</span><span class="p">,</span> <span class="n">soil_survey_props</span> <span class="o">=</span> \
        <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;soil structure&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),],</span>
                                      <span class="n">crs</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># -- determine the NRCS mukey for each soil unit; this uniquely identifies soil </span>
<span class="c1">#    properties</span>
<span class="n">soil_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">][:],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    
<span class="c1"># -- color a raster by the polygons (this makes identifying a triangle&#39;s value much </span>
<span class="c1">#    more efficient)</span>
<span class="n">soil_color_profile</span><span class="p">,</span> <span class="n">soil_color_raster</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">color_raster_from_shapes</span><span class="p">(</span><span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> 
                                                                                    <span class="mi">10</span><span class="p">,</span> <span class="n">soil_survey</span><span class="p">,</span> <span class="n">soil_ids</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># -- resample the raster to the triangles</span>
<span class="n">soil_color</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> 
                                         <span class="n">soil_color_raster</span><span class="p">,</span> <span class="n">soil_color_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 15:01:11,144 - root - INFO: 
2022-02-28 15:01:11,145 - root - INFO: Loading shapes
2022-02-28 15:01:11,146 - root - INFO: ------------------------------
2022-02-28 15:01:11,182 - root - INFO: Attempting to download source for target &#39;/Users/uec/code/watershed_workflow/data-library/soil_structure/SSURGO/SSURGO_-83.4790_35.0269_-83.4208_35.0743.shp&#39;
2022-02-28 15:01:11,200 - root - INFO:   Found 490 shapes.
2022-02-28 15:01:11,202 - root - INFO:   and crs: epsg:4326
2022-02-28 15:01:11,203 - root - INFO:   Downloaded 490 total shapes
2022-02-28 15:01:11,204 - root - INFO:   Downloaded 43 unique mukeys
2022-02-28 15:01:11,376 - root - INFO: found 43 unique MUKEYs.
2022-02-28 15:01:13,169 - root - INFO: Running Rosetta for van Genutchen parameters
2022-02-28 15:01:13,330 - root - INFO:   ... done
2022-02-28 15:01:13,333 - root - INFO:   requested 43 values
2022-02-28 15:01:13,334 - root - INFO:   got 43 responses
2022-02-28 15:01:13,343 - root - INFO: ... found 43 shapes
2022-02-28 15:01:13,344 - root - INFO: Converting to shapely
2022-02-28 15:01:13,346 - root - INFO: Converting to requested CRS
2022-02-28 15:01:13,440 - root - INFO: Coloring shapes onto raster:
2022-02-28 15:01:13,441 - root - INFO:   target_bounds = (273971.0911428096, 3878839.6361173145, 279140.9150949494, 3883953.7853134344)
2022-02-28 15:01:13,442 - root - INFO:   out_bounds = [273966.0, 3878839.0, 279146.0, 3883959.0]
2022-02-28 15:01:13,442 - root - INFO:   pixel_size = 10
2022-02-28 15:01:13,443 - root - INFO:   width = 518, height = 512
2022-02-28 15:01:13,444 - root - INFO:   and 43 independent colors of dtype int32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">soil_survey_props</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>residual saturation [-]</th>
      <th>Rosetta porosity [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>Rosetta permeability [m^2]</th>
      <th>mukey</th>
      <th>thickness [cm]</th>
      <th>permeability [m^2]</th>
      <th>porosity [-]</th>
      <th>bulk density [g/cm^3]</th>
      <th>total sand pct [%]</th>
      <th>total silt pct [%]</th>
      <th>total clay pct [%]</th>
      <th>source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.177165</td>
      <td>0.431041</td>
      <td>0.000139</td>
      <td>1.470755</td>
      <td>8.079687e-13</td>
      <td>545800</td>
      <td>203.0</td>
      <td>3.429028e-15</td>
      <td>0.307246</td>
      <td>1.297356</td>
      <td>66.356250</td>
      <td>19.518750</td>
      <td>14.125000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.177493</td>
      <td>0.432741</td>
      <td>0.000139</td>
      <td>1.469513</td>
      <td>8.184952e-13</td>
      <td>545801</td>
      <td>203.0</td>
      <td>3.247236e-15</td>
      <td>0.303714</td>
      <td>1.292308</td>
      <td>66.400000</td>
      <td>19.300000</td>
      <td>14.300000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.172412</td>
      <td>0.400889</td>
      <td>0.000150</td>
      <td>1.491087</td>
      <td>6.477202e-13</td>
      <td>545803</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.379163</td>
      <td>1.400000</td>
      <td>66.799507</td>
      <td>21.700493</td>
      <td>11.500000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.177122</td>
      <td>0.388687</td>
      <td>0.000083</td>
      <td>1.468789</td>
      <td>3.412748e-13</td>
      <td>545805</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.384877</td>
      <td>1.400000</td>
      <td>46.721675</td>
      <td>41.778325</td>
      <td>11.500000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.177122</td>
      <td>0.388687</td>
      <td>0.000083</td>
      <td>1.468789</td>
      <td>3.412748e-13</td>
      <td>545806</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.384877</td>
      <td>1.400000</td>
      <td>46.721675</td>
      <td>41.778325</td>
      <td>11.500000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.177122</td>
      <td>0.388687</td>
      <td>0.000083</td>
      <td>1.468789</td>
      <td>3.412748e-13</td>
      <td>545807</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.384877</td>
      <td>1.400000</td>
      <td>46.721675</td>
      <td>41.778325</td>
      <td>11.500000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.185732</td>
      <td>0.387543</td>
      <td>0.000162</td>
      <td>1.466606</td>
      <td>4.631920e-13</td>
      <td>545811</td>
      <td>203.0</td>
      <td>1.196738e-12</td>
      <td>0.330802</td>
      <td>1.484203</td>
      <td>68.011736</td>
      <td>18.128229</td>
      <td>13.860034</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.185732</td>
      <td>0.387543</td>
      <td>0.000162</td>
      <td>1.466606</td>
      <td>4.631920e-13</td>
      <td>545812</td>
      <td>203.0</td>
      <td>1.196738e-12</td>
      <td>0.330802</td>
      <td>1.484203</td>
      <td>68.011736</td>
      <td>18.128229</td>
      <td>13.860034</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.183468</td>
      <td>0.398767</td>
      <td>0.000127</td>
      <td>1.445858</td>
      <td>4.296896e-13</td>
      <td>545813</td>
      <td>203.0</td>
      <td>6.219065e-14</td>
      <td>0.349442</td>
      <td>1.410667</td>
      <td>60.007287</td>
      <td>26.226047</td>
      <td>13.766667</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.183709</td>
      <td>0.398135</td>
      <td>0.000126</td>
      <td>1.444985</td>
      <td>4.224967e-13</td>
      <td>545814</td>
      <td>203.0</td>
      <td>5.999907e-14</td>
      <td>0.344322</td>
      <td>1.412931</td>
      <td>59.790685</td>
      <td>26.427142</td>
      <td>13.782173</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.178116</td>
      <td>0.409712</td>
      <td>0.000161</td>
      <td>1.496402</td>
      <td>7.229891e-13</td>
      <td>545815</td>
      <td>203.0</td>
      <td>4.813863e-14</td>
      <td>0.314865</td>
      <td>1.392630</td>
      <td>70.125671</td>
      <td>16.487364</td>
      <td>13.386966</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.161194</td>
      <td>0.457152</td>
      <td>0.000168</td>
      <td>1.559659</td>
      <td>1.846434e-12</td>
      <td>545817</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.242266</td>
      <td>1.198030</td>
      <td>76.538424</td>
      <td>12.010837</td>
      <td>11.450739</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.177633</td>
      <td>0.449923</td>
      <td>0.000153</td>
      <td>1.480849</td>
      <td>1.098837e-12</td>
      <td>545818</td>
      <td>203.0</td>
      <td>2.912604e-12</td>
      <td>0.305511</td>
      <td>1.250023</td>
      <td>70.847537</td>
      <td>13.736515</td>
      <td>15.415948</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.180064</td>
      <td>0.449370</td>
      <td>0.000150</td>
      <td>1.470521</td>
      <td>1.020176e-12</td>
      <td>545819</td>
      <td>203.0</td>
      <td>2.906012e-12</td>
      <td>0.313860</td>
      <td>1.255338</td>
      <td>69.872443</td>
      <td>14.111475</td>
      <td>16.016082</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.177633</td>
      <td>0.449923</td>
      <td>0.000153</td>
      <td>1.480849</td>
      <td>1.098837e-12</td>
      <td>545820</td>
      <td>203.0</td>
      <td>2.912604e-12</td>
      <td>0.305511</td>
      <td>1.250023</td>
      <td>70.847537</td>
      <td>13.736515</td>
      <td>15.415948</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.198664</td>
      <td>0.373986</td>
      <td>0.000127</td>
      <td>1.404247</td>
      <td>2.287242e-13</td>
      <td>545829</td>
      <td>203.0</td>
      <td>1.867662e-12</td>
      <td>0.423067</td>
      <td>1.527566</td>
      <td>57.045566</td>
      <td>27.453895</td>
      <td>15.500539</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.198828</td>
      <td>0.374607</td>
      <td>0.000129</td>
      <td>1.404487</td>
      <td>2.325230e-13</td>
      <td>545830</td>
      <td>203.0</td>
      <td>1.586967e-12</td>
      <td>0.423149</td>
      <td>1.526750</td>
      <td>57.519428</td>
      <td>26.894939</td>
      <td>15.585633</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.200323</td>
      <td>0.374581</td>
      <td>0.000129</td>
      <td>1.401540</td>
      <td>2.270522e-13</td>
      <td>545831</td>
      <td>203.0</td>
      <td>1.568151e-12</td>
      <td>0.421708</td>
      <td>1.529598</td>
      <td>57.567135</td>
      <td>26.542643</td>
      <td>15.890222</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0.204093</td>
      <td>0.420703</td>
      <td>0.000124</td>
      <td>1.401781</td>
      <td>3.796359e-13</td>
      <td>545835</td>
      <td>203.0</td>
      <td>9.308050e-13</td>
      <td>0.378835</td>
      <td>1.377864</td>
      <td>58.736514</td>
      <td>21.177756</td>
      <td>20.085730</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.226801</td>
      <td>0.383730</td>
      <td>0.000111</td>
      <td>1.358205</td>
      <td>1.456048e-13</td>
      <td>545836</td>
      <td>203.0</td>
      <td>8.624357e-13</td>
      <td>0.417356</td>
      <td>1.526053</td>
      <td>51.125051</td>
      <td>26.904748</td>
      <td>21.970201</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>20</th>
      <td>0.216176</td>
      <td>0.382063</td>
      <td>0.000117</td>
      <td>1.374897</td>
      <td>1.769888e-13</td>
      <td>545837</td>
      <td>203.0</td>
      <td>1.020980e-12</td>
      <td>0.371527</td>
      <td>1.519777</td>
      <td>53.723579</td>
      <td>26.663749</td>
      <td>19.612673</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.218648</td>
      <td>0.380960</td>
      <td>0.000123</td>
      <td>1.368965</td>
      <td>1.748097e-13</td>
      <td>545838</td>
      <td>203.0</td>
      <td>1.032496e-12</td>
      <td>0.341661</td>
      <td>1.532889</td>
      <td>55.303996</td>
      <td>24.584165</td>
      <td>20.111839</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>22</th>
      <td>0.193278</td>
      <td>0.412219</td>
      <td>0.000142</td>
      <td>1.434838</td>
      <td>4.783588e-13</td>
      <td>545842</td>
      <td>203.0</td>
      <td>9.952892e-13</td>
      <td>0.386946</td>
      <td>1.400000</td>
      <td>64.415764</td>
      <td>18.601478</td>
      <td>16.982759</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>23</th>
      <td>0.200565</td>
      <td>0.409655</td>
      <td>0.000118</td>
      <td>1.409272</td>
      <td>3.388668e-13</td>
      <td>545843</td>
      <td>203.0</td>
      <td>9.952892e-13</td>
      <td>0.387980</td>
      <td>1.400000</td>
      <td>56.982759</td>
      <td>24.706897</td>
      <td>18.310345</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.148885</td>
      <td>0.384451</td>
      <td>0.000238</td>
      <td>1.853042</td>
      <td>2.027095e-12</td>
      <td>545849</td>
      <td>203.0</td>
      <td>6.249129e-12</td>
      <td>0.171281</td>
      <td>1.467488</td>
      <td>83.089655</td>
      <td>11.146798</td>
      <td>5.763547</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>25</th>
      <td>0.177184</td>
      <td>0.395081</td>
      <td>0.000122</td>
      <td>1.457442</td>
      <td>4.493285e-13</td>
      <td>545852</td>
      <td>203.0</td>
      <td>1.946014e-12</td>
      <td>0.465583</td>
      <td>1.406837</td>
      <td>58.785217</td>
      <td>29.094894</td>
      <td>12.119889</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>26</th>
      <td>0.177032</td>
      <td>0.396018</td>
      <td>0.000122</td>
      <td>1.457947</td>
      <td>4.559355e-13</td>
      <td>545853</td>
      <td>203.0</td>
      <td>2.078244e-12</td>
      <td>0.466882</td>
      <td>1.402853</td>
      <td>58.821951</td>
      <td>29.044860</td>
      <td>12.133189</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>27</th>
      <td>0.176966</td>
      <td>0.396122</td>
      <td>0.000122</td>
      <td>1.458096</td>
      <td>4.569603e-13</td>
      <td>545854</td>
      <td>203.0</td>
      <td>2.103007e-12</td>
      <td>0.467110</td>
      <td>1.402250</td>
      <td>58.811902</td>
      <td>29.064959</td>
      <td>12.123140</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>28</th>
      <td>0.149582</td>
      <td>0.384703</td>
      <td>0.000247</td>
      <td>1.928427</td>
      <td>2.349139e-12</td>
      <td>545855</td>
      <td>203.0</td>
      <td>6.238368e-12</td>
      <td>0.235555</td>
      <td>1.474297</td>
      <td>84.857230</td>
      <td>9.099160</td>
      <td>6.043611</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>29</th>
      <td>0.175471</td>
      <td>0.416598</td>
      <td>0.000147</td>
      <td>1.484106</td>
      <td>7.390878e-13</td>
      <td>545857</td>
      <td>203.0</td>
      <td>4.981053e-15</td>
      <td>0.405556</td>
      <td>1.350000</td>
      <td>67.400000</td>
      <td>19.600000</td>
      <td>13.000000</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>30</th>
      <td>0.204379</td>
      <td>0.380998</td>
      <td>0.000120</td>
      <td>1.396307</td>
      <td>2.167880e-13</td>
      <td>545859</td>
      <td>203.0</td>
      <td>1.308653e-12</td>
      <td>0.268713</td>
      <td>1.505902</td>
      <td>55.097413</td>
      <td>27.811815</td>
      <td>17.090772</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>31</th>
      <td>0.210140</td>
      <td>0.385375</td>
      <td>0.000111</td>
      <td>1.388771</td>
      <td>1.965020e-13</td>
      <td>545860</td>
      <td>203.0</td>
      <td>1.079711e-12</td>
      <td>0.288011</td>
      <td>1.492529</td>
      <td>52.434716</td>
      <td>29.038207</td>
      <td>18.527077</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>32</th>
      <td>0.202264</td>
      <td>0.393882</td>
      <td>0.000117</td>
      <td>1.404424</td>
      <td>2.644035e-13</td>
      <td>545861</td>
      <td>203.0</td>
      <td>1.968721e-12</td>
      <td>0.309901</td>
      <td>1.455172</td>
      <td>55.476355</td>
      <td>26.989163</td>
      <td>17.534483</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>33</th>
      <td>0.199673</td>
      <td>0.376928</td>
      <td>0.000127</td>
      <td>1.403759</td>
      <td>2.333276e-13</td>
      <td>545862</td>
      <td>203.0</td>
      <td>1.515968e-12</td>
      <td>0.263536</td>
      <td>1.518223</td>
      <td>57.066355</td>
      <td>27.034187</td>
      <td>15.899458</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>34</th>
      <td>0.199673</td>
      <td>0.376928</td>
      <td>0.000127</td>
      <td>1.403759</td>
      <td>2.333276e-13</td>
      <td>545863</td>
      <td>203.0</td>
      <td>1.515968e-12</td>
      <td>0.263536</td>
      <td>1.518223</td>
      <td>57.066355</td>
      <td>27.034187</td>
      <td>15.899458</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>35</th>
      <td>0.207824</td>
      <td>0.402727</td>
      <td>0.000134</td>
      <td>1.396833</td>
      <td>3.047098e-13</td>
      <td>545874</td>
      <td>203.0</td>
      <td>1.004831e-12</td>
      <td>0.366906</td>
      <td>1.452913</td>
      <td>60.366159</td>
      <td>19.989638</td>
      <td>19.644204</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>36</th>
      <td>0.204926</td>
      <td>0.403617</td>
      <td>0.000136</td>
      <td>1.404217</td>
      <td>3.310600e-13</td>
      <td>545875</td>
      <td>203.0</td>
      <td>1.116194e-12</td>
      <td>0.360041</td>
      <td>1.446720</td>
      <td>61.381676</td>
      <td>19.558623</td>
      <td>19.059702</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>37</th>
      <td>0.184037</td>
      <td>0.452018</td>
      <td>0.000141</td>
      <td>1.449088</td>
      <td>9.100580e-13</td>
      <td>545876</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.324877</td>
      <td>1.247752</td>
      <td>67.266810</td>
      <td>15.562931</td>
      <td>17.170259</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>38</th>
      <td>0.196924</td>
      <td>0.425599</td>
      <td>0.000125</td>
      <td>1.416495</td>
      <td>4.633338e-13</td>
      <td>545878</td>
      <td>185.0</td>
      <td>2.282599e-12</td>
      <td>0.364041</td>
      <td>1.346733</td>
      <td>59.965519</td>
      <td>21.381982</td>
      <td>18.652500</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>39</th>
      <td>0.182956</td>
      <td>0.364911</td>
      <td>0.000102</td>
      <td>1.437312</td>
      <td>2.342078e-13</td>
      <td>545882</td>
      <td>203.0</td>
      <td>2.894378e-12</td>
      <td>0.280336</td>
      <td>1.518895</td>
      <td>49.369529</td>
      <td>39.151513</td>
      <td>11.478958</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>40</th>
      <td>0.165660</td>
      <td>0.400572</td>
      <td>0.000183</td>
      <td>1.574297</td>
      <td>9.869368e-13</td>
      <td>545885</td>
      <td>203.0</td>
      <td>2.800000e-12</td>
      <td>0.326502</td>
      <td>1.413645</td>
      <td>74.559606</td>
      <td>15.282759</td>
      <td>10.157635</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>41</th>
      <td>0.167329</td>
      <td>0.400668</td>
      <td>0.000178</td>
      <td>1.555671</td>
      <td>9.088520e-13</td>
      <td>545886</td>
      <td>203.0</td>
      <td>1.531754e-12</td>
      <td>0.311297</td>
      <td>1.412906</td>
      <td>73.402973</td>
      <td>16.083642</td>
      <td>10.513386</td>
      <td>NRCS</td>
    </tr>
    <tr>
      <th>42</th>
      <td>0.165406</td>
      <td>0.401866</td>
      <td>0.000178</td>
      <td>1.562874</td>
      <td>9.604167e-13</td>
      <td>545887</td>
      <td>203.0</td>
      <td>1.754223e-12</td>
      <td>0.313298</td>
      <td>1.404491</td>
      <td>73.621601</td>
      <td>16.263744</td>
      <td>10.114655</td>
      <td>NRCS</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the soil mukey</span>
<span class="n">indices</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> \
        <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">generate_indexed_colormap</span><span class="p">(</span><span class="n">soil_color</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">soil_color</span><span class="p">,</span> 
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span>
                       <span class="p">)</span>

<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorbar_index</span><span class="p">(</span><span class="n">ncolors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">soil_color</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;soil type index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/Shared/ornldev/code/miniconda3/envs/watershed_workflow_DEV-2021-11-10/lib/python3.9/site-packages/pyproj/crs/crs.py:1256: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  return self._crs.to_proj4(version=version)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(273712.5998, 279399.40619999997, 3878583.92855, 3884209.4924500003)
</pre></div>
</div>
<img alt="_images/mesh_24_2.png" src="_images/mesh_24_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note this is not just the soil ID, but also soil properties.  </span>
<span class="nb">print</span><span class="p">(</span><span class="n">soil_survey_props</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># To demonstrate what we mean by this, plot the porosity of the soil column.</span>
<span class="n">porosity_nrcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">porosity_rosetta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">porosity_nrcs</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">mukey</span><span class="p">,</span><span class="s1">&#39;porosity [-]&#39;</span><span class="p">]</span>
    <span class="n">porosity_rosetta</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">mukey</span><span class="p">,</span><span class="s1">&#39;Rosetta porosity [-]&#39;</span><span class="p">]</span>

<span class="n">pmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">porosity_nrcs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">porosity_rosetta</span><span class="p">))</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">porosity_nrcs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">porosity_rosetta</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min, max = &#39;</span><span class="p">,</span> <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">porosity_nrcs</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;porosity (NRCS) [-]&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


<span class="n">ax2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">porosity_rosetta</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;porosity (Rosetta) [-]&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;residual saturation [-]&#39;, &#39;Rosetta porosity [-]&#39;,
       &#39;van Genuchten alpha [Pa^-1]&#39;, &#39;van Genuchten n [-]&#39;,
       &#39;Rosetta permeability [m^2]&#39;, &#39;mukey&#39;, &#39;thickness [cm]&#39;,
       &#39;permeability [m^2]&#39;, &#39;porosity [-]&#39;, &#39;bulk density [g/cm^3]&#39;,
       &#39;total sand pct [%]&#39;, &#39;total silt pct [%]&#39;, &#39;total clay pct [%]&#39;,
       &#39;source&#39;],
      dtype=&#39;object&#39;)
min, max =  0.0 5.432309224866e-312
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(273712.5998, 279399.40619999997, 3878583.92855, 3884209.4924500003)
</pre></div>
</div>
<img alt="_images/mesh_25_2.png" src="_images/mesh_25_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># averaging permeability is a tricky beast.  we average in log space, check that </span>
<span class="c1"># unit conversions make sense</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">soil_perm_nrcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">soil_perm_rosetta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">]:</span>
    <span class="n">soil_perm_nrcs</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">,</span> 
                                                                <span class="s1">&#39;permeability [m^2]&#39;</span><span class="p">]</span>
    <span class="n">soil_perm_rosetta</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">,</span> 
                                                                   <span class="s1">&#39;Rosetta permeability [m^2]&#39;</span><span class="p">]</span>

<span class="n">pmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_nrcs</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_rosetta</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_nrcs</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_rosetta</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

  
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;min = </span><span class="si">{</span><span class="n">pmin</span><span class="si">}</span><span class="s1">, max = </span><span class="si">{</span><span class="n">pmax</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_nrcs</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log permeability (NRCS) [m^2]&#39;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">soil_perm_rosetta</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">pmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pmax</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log permeability (Rosetta) [m^2]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>min = -14.488486163789586, max = -11.204180480714642
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;log permeability (Rosetta) [m^2]&#39;)
</pre></div>
</div>
<img alt="_images/mesh_26_2.png" src="_images/mesh_26_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># finally, let&#39;s look at the soil thickness, which will define the depth of this layer</span>
<span class="n">soil_thickness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">soil_color</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mukey</span> <span class="ow">in</span> <span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">]:</span>
    <span class="n">soil_thickness</span><span class="p">[</span><span class="n">soil_color</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil_survey_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;mukey&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mukey</span><span class="p">,</span>
                                                                <span class="s1">&#39;thickness [cm]&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">soil_thickness</span><span class="p">)</span>
<span class="n">soil_thickness</span> <span class="o">=</span> <span class="n">soil_thickness</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">soil_thickness</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;soil thickness [m]&#39;</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Median soil thickness [-] = &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">soil_thickness</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[203. 203. 203. ... 203. 203. 203.]
Median soil thickness [-] =  2.03
</pre></div>
</div>
<img alt="_images/mesh_27_1.png" src="_images/mesh_27_1.png" />
</div>
</div>
</section>
<section id="glyhmps-geologic-layer">
<h3>GLYHMPS geologic layer<a class="headerlink" href="#glyhmps-geologic-layer" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the GLYHMPS geologic structure data as shapes and project it onto the mesh</span>
<span class="n">target_bounds</span> <span class="o">=</span> <span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;target bounds: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_bounds</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">geo_survey</span><span class="p">,</span> <span class="n">geo_survey_props</span> <span class="o">=</span> \
    <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_shapes</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;geologic structure&#39;</span><span class="p">],</span> <span class="n">target_bounds</span><span class="p">,</span> 
                                  <span class="n">crs</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># -- log the bounds targetted and found</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;shape union bounds: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">shapely</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">cascaded_union</span><span class="p">(</span><span class="n">geo_survey</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span><span class="p">))</span>

<span class="c1"># -- determine the ID for each soil unit; this uniquely identifies formation</span>
<span class="c1">#    properties</span>
<span class="n">geo_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shp</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">shp</span> <span class="ow">in</span> <span class="n">geo_survey</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># -- color a raster by the polygons (this makes identifying a triangle&#39;s value much </span>
<span class="c1">#    more efficient)</span>
<span class="n">geo_color_profile</span><span class="p">,</span> <span class="n">geo_color_raster</span> <span class="o">=</span> \
            <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">color_raster_from_shapes</span><span class="p">(</span><span class="n">target_bounds</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">geo_survey</span><span class="p">,</span>
                                              <span class="n">geo_ids</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span>

<span class="c1"># -- resample the raster to the triangles</span>
<span class="n">geo_color</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> 
                                         <span class="n">geo_color_raster</span><span class="p">,</span> <span class="n">geo_color_profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 15:01:30,385 - root - INFO: target bounds: (273971.0911428096, 3878839.6361173145, 279140.9150949494, 3883953.7853134344)
2022-02-28 15:01:30,386 - root - INFO: 
2022-02-28 15:01:30,387 - root - INFO: Loading shapes
2022-02-28 15:01:30,388 - root - INFO: ------------------------------
2022-02-28 15:01:30,389 - root - INFO: Getting shapes of GLHYMPS on bounds: (273971.0911428096, 3878839.6361173145, 279140.9150949494, 3883953.7853134344)
2022-02-28 15:01:30,440 - root - INFO: ... found 1 shapes
2022-02-28 15:01:30,441 - root - INFO: Converting to shapely
2022-02-28 15:01:30,447 - root - INFO: Converting to requested CRS
2022-02-28 15:01:30,468 - root - INFO: shape union bounds: (159518.27011641115, 3816621.6554112737, 431027.3363569959, 4024643.4346461874)
2022-02-28 15:01:30,469 - root - INFO: Coloring shapes onto raster:
2022-02-28 15:01:30,470 - root - INFO:   target_bounds = (273971.0911428096, 3878839.6361173145, 279140.9150949494, 3883953.7853134344)
2022-02-28 15:01:30,471 - root - INFO:   out_bounds = [273966.0, 3878839.0, 279146.0, 3883959.0]
2022-02-28 15:01:30,471 - root - INFO:   pixel_size = 10
2022-02-28 15:01:30,472 - root - INFO:   width = 518, height = 512
2022-02-28 15:01:30,473 - root - INFO:   and 1 independent colors of dtype int32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the geologic formation id</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span>
                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">geo_color</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;soil type index&#39;</span><span class="p">)</span>
<span class="n">geo_survey_props</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>source</th>
      <th>permeability [m^2]</th>
      <th>logk_stdev [-]</th>
      <th>porosity [-]</th>
      <th>van Genuchten alpha [Pa^-1]</th>
      <th>van Genuchten n [-]</th>
      <th>residual saturation [-]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1793338</td>
      <td>GLHYMPS</td>
      <td>3.019952e-11</td>
      <td>1.61</td>
      <td>0.01</td>
      <td>0.023953</td>
      <td>2.0</td>
      <td>0.01</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/mesh_30_1.png" src="_images/mesh_30_1.png" />
</div>
</div>
</section>
</section>
<section id="depth-to-bedrock">
<h2>Depth-to-bedrock<a class="headerlink" href="#depth-to-bedrock" title="Permalink to this headline">#</a></h2>
<p>Depth to bedrock is taken from the <a class="reference external" href="http://globalchange.bnu.edu.cn/research/dtb.jsp">SoilGrids</a> product.  Here we download a US-based, clipped version of this global product, as file sizes are quite large (all products potentially used total over 100GB).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DTB_profile</span><span class="p">,</span> <span class="n">DTB_raster</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">get_raster_on_shape</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;depth to bedrock&#39;</span><span class="p">],</span> 
                                                                 <span class="n">coweeta</span><span class="o">.</span><span class="n">exterior</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> 
                                                                 <span class="n">nodata</span><span class="o">=-</span><span class="mi">99999</span><span class="p">)</span>
                                        <span class="c1">#, variable=&#39;BDTICM&#39;) # note, this argument needed for </span>
                                        <span class="c1"># using the default SoilGrids dataset.</span>

<span class="c1"># resample the raster to the triangles</span>
<span class="n">DTB_raster</span> <span class="o">=</span> <span class="n">DTB_raster</span><span class="o">/</span><span class="mi">100</span> <span class="c1">#convert from cm to m</span>
<span class="n">DTB</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">values_from_raster</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">centroids</span><span class="p">(),</span> <span class="n">crs</span><span class="p">,</span> <span class="n">DTB_raster</span><span class="p">,</span> <span class="n">DTB_profile</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;piecewise bilinear&#39;</span><span class="p">)</span>
<span class="n">DTB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DTB</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DTB</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 15:01:38,439 - root - INFO: 
2022-02-28 15:01:38,440 - root - INFO: Loading Raster
2022-02-28 15:01:38,441 - root - INFO: ------------------------------
2022-02-28 15:01:38,442 - root - INFO: Collecting raster
2022-02-28 15:01:38,457 - root - INFO: bounds in my_crs: (-83.47845037186387, 35.02734099944037, -83.42165773504303, 35.07381933600275)
2022-02-28 15:01:38,459 - root - INFO: ... got raster of shape: (23, 28)
2022-02-28 15:01:38,460 - root - INFO: ... got raster bounds: (-83.47918210999998, 35.074175034, -83.42084878599998, 35.026258375)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the resulting surface mesh</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">get_ax</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">triangulation</span><span class="p">(</span><span class="n">mesh_points3</span><span class="p">,</span> <span class="n">mesh_tris</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">DTB</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma_r&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;DTB [m]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/Shared/ornldev/code/miniconda3/envs/watershed_workflow_DEV-2021-11-10/lib/python3.9/site-packages/pyproj/crs/crs.py:1256: UserWarning: You will likely lose important projection information when converting to a PROJ string from another format. See: https://proj.org/faq.html#what-is-the-best-format-for-describing-coordinate-reference-systems
  return self._crs.to_proj4(version=version)
</pre></div>
</div>
<img alt="_images/mesh_33_1.png" src="_images/mesh_33_1.png" />
</div>
</div>
</section>
<section id="mesh-extrusion">
<h2>Mesh extrusion<a class="headerlink" href="#mesh-extrusion" title="Permalink to this headline">#</a></h2>
<p>Given the surface mesh and material IDs on both the surface and subsurface, we can extrude the surface mesh in the vertical to make a 3D mesh.</p>
<p>First, all integer IDs in Exodus files must be unique.  This includes Material IDs, side sets, etc.  We create the Material ID map and data frame.  This is used to standardize IDs from multiple data sources.  Traditionally, ATS numbers Material IDs/Side Sets as:</p>
<ul class="simple">
<li><p>0-9 : reserved for boundaries, surface/bottom, etc</p></li>
<li><p>10-99 : Land Cover side sets, typically NLCD IDs are used</p></li>
<li><p>100-999 : geologic layer material IDs</p></li>
<li><p>1000-9999 : soil layer material IDs</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">soil_survey_props</span><span class="p">[</span><span class="s1">&#39;ats_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">soil_survey_props</span><span class="p">))</span>
<span class="n">soil_survey_props</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ats_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">geo_survey_props</span><span class="p">[</span><span class="s1">&#39;ats_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">geo_survey_props</span><span class="p">))</span>
<span class="n">geo_survey_props</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ats_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">subsurface_props</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">geo_survey_props</span><span class="p">,</span><span class="n">soil_survey_props</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># must choose properties for geologic media.  Here we choose one that has a similar porosity</span>
<span class="n">subsurface_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;residual saturation [-]&#39;</span><span class="p">,</span> <span class="s1">&#39;van Genuchten alpha [Pa^-1]&#39;</span><span class="p">,</span> <span class="s1">&#39;van Genuchten n [-]&#39;</span><span class="p">]]</span> <span class="o">=</span>  \
      <span class="n">subsurface_props</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;residual saturation [-]&#39;</span><span class="p">,</span> <span class="s1">&#39;van Genuchten alpha [Pa^-1]&#39;</span><span class="p">,</span> <span class="s1">&#39;van Genuchten n [-]&#39;</span><span class="p">]]</span> 

<span class="c1"># save the properties to disk for use in generating input file</span>
<span class="n">subsurface_props</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Coweeta&#39;</span><span class="p">,</span> <span class="s1">&#39;output_data&#39;</span><span class="p">,</span> <span class="s1">&#39;coweeta_subsurface_properties.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Next we extrude the DEM to create a 3D mesh.</p>
<p>The most difficult aspect of extrusion is creating meshes that:</p>
<ol class="simple">
<li><p>aren’t huge numbers of cells</p></li>
<li><p>aren’t huge cell thicknesses, especially near the surface</p></li>
<li><p>follow implied interfaces, e.g. bottom of soil and bottom of geologic layer</p></li>
</ol>
<p>This is an iterative process that requires some care and some art.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate a dz structure for the top 2m of soil -- it appears from above that the soil thickness is uniformly 2m</span>
<span class="c1">#</span>
<span class="c1"># here we try for 10 cells, starting at 5cm at the top and going to 50cm at the bottom of the 2m thick soil</span>
<span class="n">dzs</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">optimize_dzs</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dzs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.0500016  0.05030145 0.06625834 0.1110568  0.22600204 0.49640501
 0.49997989 0.49999487]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this looks like it would work out:</span>
<span class="n">dzs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dzs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a 2m soil thickness and a maximum of 20m depth to bedrock suggests a</span>
<span class="c1"># geologic layer of 18 - 1m cells</span>
<span class="n">dzs</span> <span class="o">=</span> <span class="n">dzs</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,]</span><span class="o">*</span><span class="mi">18</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># layer extrusion</span>
<span class="c1"># -- data structures needed for extrusion</span>
<span class="n">layer_types</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">layer_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">layer_ncells</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">layer_mat_ids</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># -- add the layers</span>
<span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">dz</span> <span class="ow">in</span> <span class="n">dzs</span><span class="p">:</span>
    <span class="n">layer_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">layer_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
    <span class="n">layer_ncells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># to set the layer type, we check whether it is</span>
    <span class="c1">#   * above the soil thickness (it is soil)</span>
    <span class="c1">#   * below the depth to bedrock (it is bedrock)</span>
    <span class="c1">#   * else it is geologic layer</span>
    <span class="c1"># -- set the depth as the cell midpoint</span>
    <span class="n">depth</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dz</span>
    
    <span class="c1"># -- bedrock (999) or geologic layer (from geo_color)</span>
    <span class="n">br_or_geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">DTB</span><span class="p">,</span> <span class="n">geo_color</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
    
    <span class="c1"># -- are we in the soil horizons?</span>
    <span class="n">mat_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">soil_color</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">soil_thickness</span><span class="p">),</span>
                      <span class="n">soil_color</span><span class="p">,</span> <span class="n">br_or_geo</span><span class="p">)</span>

    <span class="n">depth</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dz</span>
    <span class="n">layer_mat_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat_id</span><span class="p">)</span>
    
<span class="c1"># print the summary</span>
<span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh3D</span><span class="o">.</span><span class="n">summarize_extrusion</span><span class="p">(</span><span class="n">layer_types</span><span class="p">,</span> <span class="n">layer_data</span><span class="p">,</span> 
                                            <span class="n">layer_ncells</span><span class="p">,</span> <span class="n">layer_mat_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 15:01:46,143 - root - INFO: Cell summary:
2022-02-28 15:01:46,143 - root - INFO: ------------------------------------------------------------
2022-02-28 15:01:46,144 - root - INFO: l_id	| c_id	|mat_id	| dz		| z_top
2022-02-28 15:01:46,146 - root - INFO: ------------------------------------------------------------
2022-02-28 15:01:46,147 - root - INFO:  00 	| 00 	| 545887 	|   0.050000 	|   0.000000
2022-02-28 15:01:46,147 - root - INFO:  01 	| 01 	| 545887 	|   0.050000 	|   0.050000
2022-02-28 15:01:46,148 - root - INFO:  02 	| 02 	| 545887 	|   0.050000 	|   0.100000
2022-02-28 15:01:46,149 - root - INFO:  03 	| 03 	| 545887 	|   0.120000 	|   0.150000
2022-02-28 15:01:46,150 - root - INFO:  04 	| 04 	| 545887 	|   0.230000 	|   0.270000
2022-02-28 15:01:46,151 - root - INFO:  05 	| 05 	| 545887 	|   0.500000 	|   0.500000
2022-02-28 15:01:46,152 - root - INFO:  06 	| 06 	| 545887 	|   0.500000 	|   1.000000
2022-02-28 15:01:46,153 - root - INFO:  07 	| 07 	| 545887 	|   0.500000 	|   1.500000
2022-02-28 15:01:46,154 - root - INFO:  08 	| 08 	| 1793338 	|   1.000000 	|   2.000000
2022-02-28 15:01:46,155 - root - INFO:  09 	| 09 	| 1793338 	|   1.000000 	|   3.000000
2022-02-28 15:01:46,156 - root - INFO:  10 	| 10 	| 1793338 	|   1.000000 	|   4.000000
2022-02-28 15:01:46,157 - root - INFO:  11 	| 11 	| 1793338 	|   1.000000 	|   5.000000
2022-02-28 15:01:46,158 - root - INFO:  12 	| 12 	| 1793338 	|   1.000000 	|   6.000000
2022-02-28 15:01:46,159 - root - INFO:  13 	| 13 	| 1793338 	|   1.000000 	|   7.000000
2022-02-28 15:01:46,160 - root - INFO:  14 	| 14 	| 1793338 	|   1.000000 	|   8.000000
2022-02-28 15:01:46,161 - root - INFO:  15 	| 15 	| 1793338 	|   1.000000 	|   9.000000
2022-02-28 15:01:46,162 - root - INFO:  16 	| 16 	| 1793338 	|   1.000000 	|  10.000000
2022-02-28 15:01:46,164 - root - INFO:  17 	| 17 	| 1793338 	|   1.000000 	|  11.000000
2022-02-28 15:01:46,165 - root - INFO:  18 	| 18 	| 1793338 	|   1.000000 	|  12.000000
2022-02-28 15:01:46,165 - root - INFO:  19 	| 19 	| 1793338 	|   1.000000 	|  13.000000
2022-02-28 15:01:46,166 - root - INFO:  20 	| 20 	| 1793338 	|   1.000000 	|  14.000000
2022-02-28 15:01:46,167 - root - INFO:  21 	| 21 	| 1793338 	|   1.000000 	|  15.000000
2022-02-28 15:01:46,168 - root - INFO:  22 	| 22 	| 1793338 	|   1.000000 	|  16.000000
2022-02-28 15:01:46,169 - root - INFO:  23 	| 23 	|  999 	|   1.000000 	|  17.000000
2022-02-28 15:01:46,170 - root - INFO:  24 	| 24 	|  999 	|   1.000000 	|  18.000000
2022-02-28 15:01:46,171 - root - INFO:  25 	| 25 	|  999 	|   1.000000 	|  19.000000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extrude</span>
<span class="n">m3</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh3D</span><span class="o">.</span><span class="n">extruded_Mesh2D</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">layer_types</span><span class="p">,</span> <span class="n">layer_data</span><span class="p">,</span> 
                                             <span class="n">layer_ncells</span><span class="p">,</span> <span class="n">layer_mat_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add back on land cover side sets</span>
<span class="n">surf_ss</span> <span class="o">=</span> <span class="n">m3</span><span class="o">.</span><span class="n">side_sets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nlcd_indices</span><span class="p">,</span> <span class="n">nlcd_labels</span><span class="p">):</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lc</span> <span class="o">==</span> <span class="n">index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">watershed_workflow</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">SideSet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> 
                            <span class="p">[</span><span class="n">surf_ss</span><span class="o">.</span><span class="n">elem_list</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">where</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">surf_ss</span><span class="o">.</span><span class="n">side_list</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">where</span><span class="p">])</span>        
    <span class="n">m3</span><span class="o">.</span><span class="n">side_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save to disk</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Coweeta&#39;</span><span class="p">,</span> <span class="s1">&#39;output_data&#39;</span><span class="p">,</span> <span class="s1">&#39;coweeta_basin.exo&#39;</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">m3</span><span class="o">.</span><span class="n">write_exodus</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Coweeta&#39;</span><span class="p">,</span> <span class="s1">&#39;output_data&#39;</span><span class="p">,</span> <span class="s1">&#39;coweeta_basin.exo&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You are using exodus.py v 1.20.10 (seacas-py3), a python wrapper of some of the exodus library.

Copyright (c) 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021 National Technology &amp;
Engineering Solutions of Sandia, LLC (NTESS).  Under the terms of
Contract DE-NA0003525 with NTESS, the U.S. Government retains certain
rights in this software.

Opening exodus file: Coweeta/output_data/coweeta_basin.exo
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-28 15:02:00,627 - root - INFO: adding side set: 1
2022-02-28 15:02:00,678 - root - INFO: adding side set: 2
2022-02-28 15:02:00,733 - root - INFO: adding side set: 3
2022-02-28 15:02:00,775 - root - INFO: adding side set: 21
2022-02-28 15:02:00,815 - root - INFO: adding side set: 22
2022-02-28 15:02:00,854 - root - INFO: adding side set: 23
2022-02-28 15:02:00,891 - root - INFO: adding side set: 41
2022-02-28 15:02:00,938 - root - INFO: adding side set: 42
2022-02-28 15:02:00,975 - root - INFO: adding side set: 43
2022-02-28 15:02:01,020 - root - INFO: adding side set: 52
2022-02-28 15:02:01,057 - root - INFO: adding side set: 81
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Closing exodus file: Coweeta/output_data/coweeta_basin.exo
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-watershed_workflow_DEV-2021-11-10-py"
        },
        kernelOptions: {
            kernelName: "conda-env-watershed_workflow_DEV-2021-11-10-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-watershed_workflow_DEV-2021-11-10-py'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">ATS modeling workflow</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="daymet.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Download Daymet</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Pin Shuai, Ethan Coon, and etc.<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>